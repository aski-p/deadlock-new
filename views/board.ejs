<div class="board-section">
    <div class="board-container">
        <div class="board-header">
            <h1 class="page-title">ê²Œì‹œíŒ</h1>
            <% if (user) { %>
                <button class="write-post-btn" id="writePostBtn">âœï¸ ê¸€ì“°ê¸°</button>
            <% } else { %>
                <p class="login-notice">ê¸€ì“°ê¸°ì™€ ëŒ“ê¸€ ì‘ì„±ì„ ìœ„í•´ì„œëŠ” <a href="/auth/steam" class="steam-login-link">Steam ë¡œê·¸ì¸</a>ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
            <% } %>
        </div>

        <!-- ê¸€ì“°ê¸° í¼ -->
        <div class="write-form-section" id="writeFormSection" style="display: none;">
            <div class="write-form">
                <h3>ìƒˆ ê¸€ ì‘ì„±</h3>
                <form id="writePostForm">
                    <div class="form-group">
                        <label for="postTitle">ì œëª©</label>
                        <input type="text" id="postTitle" name="title" required maxlength="100">
                    </div>
                    <div class="form-group">
                        <label for="postContent">ë‚´ìš©</label>
                        <textarea id="postContent" name="content" required rows="8" maxlength="2000"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="imageUpload">ì´ë¯¸ì§€ ì²¨ë¶€ (ì„ íƒì‚¬í•­)</label>
                        <div class="image-upload-container">
                            <input type="file" id="imageUpload" accept="image/*" style="display: none;">
                            <button type="button" class="image-upload-btn" id="imageUploadBtn">
                                ğŸ“· ì´ë¯¸ì§€ ì„ íƒ
                            </button>
                            <div class="upload-info">
                                <small>ìµœëŒ€ 5MB, JPG/PNG/GIF í˜•ì‹ ì§€ì›</small>
                            </div>
                            <div class="image-preview-container" id="imagePreviewContainer" style="display: none;">
                                <div class="image-preview">
                                    <img id="imagePreview" src="" alt="ë¯¸ë¦¬ë³´ê¸°">
                                    <button type="button" class="remove-image-btn" id="removeImageBtn">Ã—</button>
                                </div>
                                <div class="upload-progress" id="uploadProgress" style="display: none;">
                                    <div class="progress-bar">
                                        <div class="progress-fill" id="progressFill"></div>
                                    </div>
                                    <span class="progress-text" id="progressText">ì—…ë¡œë“œ ì¤‘...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="submit-btn">ì‘ì„±í•˜ê¸°</button>
                        <button type="button" class="cancel-btn" id="cancelWriteBtn">ì·¨ì†Œ</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ê²Œì‹œê¸€ í…Œì´ë¸” -->
        <div class="posts-container">
            <div class="posts-loading" id="postsLoading">
                <div class="loading-spinner"></div>
                <p>ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
            
            <div class="posts-table-container" id="postsTableContainer" style="display: none;">
                <table class="posts-table">
                    <thead>
                        <tr>
                            <th class="seq-column">ë²ˆí˜¸</th>
                            <th class="date-column">ë‚ ì§œ</th>
                            <th class="title-column">ì œëª©</th>
                            <th class="author-column">ê¸€ì“´ì´</th>
                            <th class="views-column">ì¡°íšŒìˆ˜</th>
                            <th class="comments-column">ëŒ“ê¸€</th>
                        </tr>
                    </thead>
                    <tbody id="postsTableBody">
                        <!-- ê²Œì‹œê¸€ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
                    </tbody>
                </table>
            </div>
            
            <div class="pagination" id="pagination" style="display: none;">
                <button class="page-btn" id="prevBtn">ì´ì „</button>
                <span class="page-info" id="pageInfo">1 / 1</span>
                <button class="page-btn" id="nextBtn">ë‹¤ìŒ</button>
            </div>
        </div>
    </div>
</div>

<!-- ê²Œì‹œê¸€ ìƒì„¸ ëª¨ë‹¬ -->
<div class="post-modal" id="postModal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">ê²Œì‹œê¸€ ì œëª©</h2>
            <div class="modal-actions">
                <div class="post-actions" id="postActions" style="display: none;">
                    <button class="edit-btn" id="editPostBtn">ìˆ˜ì •</button>
                    <button class="delete-btn" id="deletePostBtn">ì‚­ì œ</button>
                </div>
                <button class="close-btn" id="closeModalBtn">&times;</button>
            </div>
        </div>
        <div class="modal-body">
            <div class="post-info">
                <div class="post-author">
                    <img id="modalAuthorAvatar" src="" alt="ì‘ì„±ì" class="author-avatar">
                    <span id="modalAuthorName">ì‘ì„±ì</span>
                    <img id="modalAuthorRank" src="" alt="" class="rank-badge" style="display: none;">
                </div>
                <div class="post-meta">
                    <span id="modalDate">2025-01-01</span>
                    <span>ì¡°íšŒìˆ˜: <span id="modalViews">0</span></span>
                </div>
            </div>
            <div class="post-content" id="modalContent">
                ê²Œì‹œê¸€ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
            </div>
            
            <!-- ìˆ˜ì • í¼ (ìˆ¨ê¹€) -->
            <div class="edit-form" id="editForm" style="display: none;">
                <div class="form-group">
                    <label for="editTitle">ì œëª©</label>
                    <input type="text" id="editTitle" maxlength="100" required>
                </div>
                <div class="form-group">
                    <label for="editContent">ë‚´ìš©</label>
                    <textarea id="editContent" rows="8" maxlength="2000" required></textarea>
                </div>
                <div class="form-actions">
                    <button id="saveEditBtn" class="submit-btn">ì €ì¥</button>
                    <button id="cancelEditBtn" class="cancel-btn">ì·¨ì†Œ</button>
                </div>
            </div>
            
            <!-- ëŒ“ê¸€ ì„¹ì…˜ -->
            <div class="comments-section">
                <h3>ëŒ“ê¸€ <span id="commentsCount">0</span>ê°œ</h3>
                <div class="comments-list" id="commentsList">
                    <!-- ëŒ“ê¸€ë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
                
                <% if (user) { %>
                <div class="comment-form">
                    <textarea id="commentInput" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." rows="3"></textarea>
                    <button id="addCommentBtn" class="comment-submit-btn">ëŒ“ê¸€ ì‘ì„±</button>
                </div>
                <% } else { %>
                <p class="login-notice">ëŒ“ê¸€ ì‘ì„±ì„ ìœ„í•´ì„œëŠ” <a href="/auth/steam">Steam ë¡œê·¸ì¸</a>ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
                <% } %>
            </div>
        </div>
    </div>
</div>

<style>
.board-section {
    padding: 120px 0 60px;
    min-height: 100vh;
    background: #000000;
    color: #FFEFD7;
}

.board-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 0 20px;
}

.board-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 40px;
    padding-bottom: 20px;
    border-bottom: 2px solid #63a2e2;
}

.page-title {
    font-size: 32px;
    font-weight: 700;
    color: #FFEFD7;
    margin: 0;
}

.write-post-btn {
    background: #63a2e2;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
}

.write-post-btn:hover {
    background: #4f8bc9;
    transform: translateY(-2px);
}

.login-notice {
    color: #999;
    font-size: 14px;
}

.steam-login-link {
    color: #63a2e2;
    text-decoration: none;
}

.steam-login-link:hover {
    text-decoration: underline;
}

.write-form-section {
    background: rgba(255, 255, 255, 0.05);
    padding: 30px;
    border-radius: 12px;
    margin-bottom: 30px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.write-form h3 {
    margin-bottom: 20px;
    color: #63a2e2;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #FFEFD7;
}

.form-group input, .form-group textarea {
    width: 100%;
    padding: 12px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 6px;
    background: rgba(255, 255, 255, 0.05);
    color: #FFEFD7;
    font-size: 14px;
    box-sizing: border-box;
}

.form-group input:focus, .form-group textarea:focus {
    outline: none;
    border-color: #63a2e2;
    background: rgba(255, 255, 255, 0.08);
}

.form-actions {
    display: flex;
    gap: 12px;
}

.submit-btn, .cancel-btn {
    padding: 12px 24px;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
}

.submit-btn {
    background: #63a2e2;
    color: white;
}

.submit-btn:hover {
    background: #4f8bc9;
}

.cancel-btn {
    background: rgba(255, 255, 255, 0.1);
    color: #FFEFD7;
}

.cancel-btn:hover {
    background: rgba(255, 255, 255, 0.15);
}

.posts-loading {
    text-align: center;
    padding: 60px 20px;
    color: #999;
}

.loading-spinner {
    width: 40px;
    height: 40px;
    border: 4px solid rgba(99, 162, 226, 0.3);
    border-left: 4px solid #63a2e2;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* ê²Œì‹œê¸€ í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
.posts-table-container {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.posts-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
}

.posts-table thead {
    background: rgba(99, 162, 226, 0.2);
}

.posts-table th {
    padding: 15px 12px;
    text-align: left;
    font-weight: 600;
    color: #FFEFD7;
    border-bottom: 2px solid rgba(255, 255, 255, 0.1);
}

.posts-table td {
    padding: 12px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    color: #FFEFD7;
    vertical-align: middle;
}

.posts-table tbody tr {
    transition: all 0.3s;
    cursor: pointer;
}

.posts-table tbody tr:hover {
    background: rgba(99, 162, 226, 0.1);
}

/* í…Œì´ë¸” ì»¬ëŸ¼ ë„ˆë¹„ */
.seq-column { width: 60px; text-align: center; font-weight: bold; color: #999; }
.date-column { width: 120px; }
.title-column { width: auto; min-width: 300px; }
.author-column { width: 150px; }
.views-column { width: 80px; text-align: center; }
.comments-column { width: 80px; text-align: center; }

.post-title-link {
    color: #FFEFD7;
    text-decoration: none;
    font-weight: 500;
    display: block;
    padding: 4px 0;
}

.post-title-link:hover {
    color: #63a2e2;
    text-decoration: underline;
}

.post-author {
    display: flex;
    align-items: center;
    gap: 8px;
}

.author-avatar {
    width: 24px;
    height: 24px;
    border-radius: 50%;
}

.post-date {
    color: #999;
    font-size: 12px;
}

/* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
.post-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: #1a1a1a;
    border-radius: 12px;
    max-width: 800px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.modal-header h2 {
    margin: 0;
    color: #FFEFD7;
    font-size: 20px;
    flex: 1;
}

.close-btn {
    background: none;
    border: none;
    color: #999;
    font-size: 24px;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.close-btn:hover {
    color: #FFEFD7;
}

.modal-actions {
    display: flex;
    align-items: center;
    gap: 10px;
}

.post-actions {
    display: flex;
    gap: 8px;
}

.edit-btn, .delete-btn {
    padding: 6px 12px;
    border: none;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s;
}

.edit-btn {
    background: #4CAF50;
    color: white;
}

.edit-btn:hover {
    background: #45a049;
}

.delete-btn {
    background: #f44336;
    color: white;
}

.delete-btn:hover {
    background: #da190b;
}

.rank-badge {
    width: 20px;
    height: 20px;
    margin-left: 4px;
    vertical-align: middle;
}

.modal-body {
    padding: 20px;
}

.post-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.post-meta {
    display: flex;
    gap: 20px;
    font-size: 12px;
    color: #999;
}

.post-content {
    color: #FFEFD7;
    line-height: 1.6;
    margin-bottom: 30px;
    white-space: pre-wrap;
    word-wrap: break-word;
}

.comments-section {
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    padding-top: 20px;
}

.comments-section h3 {
    color: #FFEFD7;
    margin-bottom: 15px;
}

.comment-item {
    background: rgba(255, 255, 255, 0.05);
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 10px;
}

.comment-author {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
}

.comment-content {
    color: #ccc;
    line-height: 1.4;
    white-space: pre-wrap;
    word-wrap: break-word;
}

.comment-date {
    color: #999;
    font-size: 11px;
    margin-top: 5px;
}

.comment-form {
    margin-top: 20px;
}

.comment-form textarea {
    width: 100%;
    padding: 12px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 6px;
    background: rgba(255, 255, 255, 0.05);
    color: #FFEFD7;
    font-size: 14px;
    box-sizing: border-box;
    resize: vertical;
    margin-bottom: 10px;
}

.comment-submit-btn {
    background: #63a2e2;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
}

.comment-submit-btn:hover {
    background: #4f8bc9;
}

.pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 20px;
    margin-top: 40px;
}

.page-btn {
    background: #63a2e2;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s;
}

.page-btn:hover:not(:disabled) {
    background: #4f8bc9;
}

.page-btn:disabled {
    background: rgba(255, 255, 255, 0.1);
    color: #666;
    cursor: not-allowed;
}

.page-info {
    color: #FFEFD7;
    font-weight: 600;
}

/* ë°˜ì‘í˜• */
@media (max-width: 768px) {
    .board-header {
        flex-direction: column;
        gap: 20px;
        text-align: center;
    }
    
    .post-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }
    
    .post-meta {
        flex-wrap: wrap;
    }
}
</style>

<script>
let currentPage = 1;
let totalPages = 1;
let currentPostId = null;

// í˜ì´ì§€ ë¡œë“œ ì‹œ ê²Œì‹œê¸€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
document.addEventListener('DOMContentLoaded', () => {
    loadPosts();
    setupEventListeners();
    initImageUpload();
});

// ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
function setupEventListeners() {
    // ê¸€ì“°ê¸° ë²„íŠ¼
    const writePostBtn = document.getElementById('writePostBtn');
    if (writePostBtn) {
        writePostBtn.addEventListener('click', showWriteForm);
    }
    
    // ê¸€ì“°ê¸° ì·¨ì†Œ ë²„íŠ¼
    const cancelWriteBtn = document.getElementById('cancelWriteBtn');
    if (cancelWriteBtn) {
        cancelWriteBtn.addEventListener('click', hideWriteForm);
    }
    
    // í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼
    const prevBtn = document.getElementById('prevBtn');
    if (prevBtn) {
        prevBtn.addEventListener('click', () => changePage(-1));
    }
    
    const nextBtn = document.getElementById('nextBtn');
    if (nextBtn) {
        nextBtn.addEventListener('click', () => changePage(1));
    }
    
    // ëª¨ë‹¬ ê´€ë ¨ ë²„íŠ¼
    const closeModalBtn = document.getElementById('closeModalBtn');
    if (closeModalBtn) {
        closeModalBtn.addEventListener('click', closePostModal);
    }
    
    const editPostBtn = document.getElementById('editPostBtn');
    if (editPostBtn) {
        editPostBtn.addEventListener('click', editPost);
    }
    
    const deletePostBtn = document.getElementById('deletePostBtn');
    if (deletePostBtn) {
        deletePostBtn.addEventListener('click', deletePost);
    }
    
    const saveEditBtn = document.getElementById('saveEditBtn');
    if (saveEditBtn) {
        saveEditBtn.addEventListener('click', saveEdit);
    }
    
    const cancelEditBtn = document.getElementById('cancelEditBtn');
    if (cancelEditBtn) {
        cancelEditBtn.addEventListener('click', cancelEdit);
    }
    
    const addCommentBtn = document.getElementById('addCommentBtn');
    if (addCommentBtn) {
        addCommentBtn.addEventListener('click', addComment);
    }
    
    // ê²Œì‹œê¸€ í…Œì´ë¸” í´ë¦­ ì´ë²¤íŠ¸ (ì´ë²¤íŠ¸ ìœ„ì„)
    const postsTableBody = document.getElementById('postsTableBody');
    if (postsTableBody) {
        postsTableBody.addEventListener('click', (e) => {
            const row = e.target.closest('.post-row');
            if (row) {
                const postId = parseInt(row.dataset.postId);
                if (postId) {
                    openPostModal(postId);
                }
            }
        });
    }
}

// ê²Œì‹œê¸€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (50ê°œì”©)
async function loadPosts(page = 1) {
    const loading = document.getElementById('postsLoading');
    const tableContainer = document.getElementById('postsTableContainer');
    const pagination = document.getElementById('pagination');
    
    loading.style.display = 'block';
    tableContainer.style.display = 'none';
    pagination.style.display = 'none';
    
    try {
        const response = await fetch(`/api/v1/board/posts?page=${page}`);
        const data = await response.json();
        
        if (response.ok) {
            currentPage = data.currentPage;
            totalPages = data.totalPages;
            
            displayPostsTable(data.posts, data.totalPosts, data.currentPage);
            updatePagination();
            
            loading.style.display = 'none';
            tableContainer.style.display = 'block';
            if (totalPages > 1) {
                pagination.style.display = 'flex';
            }
        } else {
            throw new Error(data.error || 'ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }
    } catch (error) {
        console.error('ê²Œì‹œê¸€ ë¡œë”© ì˜¤ë¥˜:', error);
        loading.innerHTML = '<p style="color: #ff6b6b;">ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
    }
}

// ê²Œì‹œê¸€ í…Œì´ë¸” í‘œì‹œ
function displayPostsTable(posts, totalCount, currentPage) {
    const tableBody = document.getElementById('postsTableBody');
    
    if (posts.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999; padding: 40px;">ì•„ì§ ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
    }
    
    // í˜ì´ì§€ë‹¹ 50ê°œì”©ì´ë¯€ë¡œ í˜„ì¬ í˜ì´ì§€ì˜ ì‹œì‘ ë²ˆí˜¸ ê³„ì‚°
    const postsPerPage = 50;
    const startNumber = totalCount - ((currentPage - 1) * postsPerPage);
    
    tableBody.innerHTML = posts.map((post, index) => {
        const sequenceNumber = startNumber - index;
        return `
        <tr data-post-id="${post.id}" class="post-row" style="cursor: pointer;">
            <td class="seq-column" style="text-align: center;">
                ${sequenceNumber}
            </td>
            <td class="date-column">
                <div class="post-date">${formatDate(post.created_at)}</div>
            </td>
            <td class="title-column">
                <div class="post-title-link">${escapeHtml(post.title)}</div>
            </td>
            <td class="author-column">
                <div class="post-author">
                    <img src="${post.author_avatar}" alt="${post.author_username}" class="author-avatar post-author-avatar">
                    <span>${escapeHtml(post.author_username)}</span>
                    ${post.rank_image ? `<img src="/images/ranks/${post.rank_image}" alt="${post.rank_name}" class="rank-badge" title="${post.rank_name} (${post.points || 0}ì )">` : ''}
                </div>
            </td>
            <td class="views-column" style="text-align: center;">
                ${post.view_count || 0}
            </td>
            <td class="comments-column" style="text-align: center;">
                ${post.commentCount || 0}
            </td>
        </tr>
        `;
    }).join('');
    
    // ìƒˆë¡œ ì¶”ê°€ëœ ì´ë¯¸ì§€ë“¤ì— ì˜¤ë¥˜ í•¸ë“¤ëŸ¬ ì¶”ê°€
    setupImageErrorHandlers();
}

// í˜ì´ì§€ë„¤ì´ì…˜ ì—…ë°ì´íŠ¸
function updatePagination() {
    document.getElementById('pageInfo').textContent = `${currentPage} / ${totalPages}`;
    document.getElementById('prevBtn').disabled = currentPage === 1;
    document.getElementById('nextBtn').disabled = currentPage === totalPages;
}

// í˜ì´ì§€ ë³€ê²½
function changePage(direction) {
    const newPage = currentPage + direction;
    if (newPage >= 1 && newPage <= totalPages) {
        loadPosts(newPage);
    }
}

// ê¸€ì“°ê¸° í¼ í‘œì‹œ
function showWriteForm() {
    document.getElementById('writeFormSection').style.display = 'block';
    document.getElementById('postTitle').focus();
}

// ê¸€ì“°ê¸° í¼ ìˆ¨ê¸°ê¸°
function hideWriteForm() {
    document.getElementById('writeFormSection').style.display = 'none';
    document.getElementById('writePostForm').reset();
    
    // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ì´ˆê¸°í™”
    const imagePreviewContainer = document.getElementById('imagePreviewContainer');
    const imagePreview = document.getElementById('imagePreview');
    const imageUpload = document.getElementById('imageUpload');
    
    if (imagePreviewContainer) imagePreviewContainer.style.display = 'none';
    if (imagePreview) imagePreview.src = '';
    if (imageUpload) imageUpload.value = '';
    uploadedImageUrl = null;
}

// ê²Œì‹œê¸€ ì‘ì„±
document.getElementById('writePostForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const title = document.getElementById('postTitle').value.trim();
    const content = getPostContent().trim();
    
    if (!title || !content) {
        alert('ì œëª©ê³¼ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    try {
        const response = await fetch('/api/v1/board/posts', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ title, content })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            hideWriteForm();
            loadPosts(1); // ì²« í˜ì´ì§€ë¡œ ì´ë™
            alert('ê²Œì‹œê¸€ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤! (+10ì  íšë“)');
        } else {
            alert(data.error || 'ê²Œì‹œê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        console.error('ê²Œì‹œê¸€ ì‘ì„± ì˜¤ë¥˜:', error);
        alert('ê²Œì‹œê¸€ ì‘ì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
});

// ê²Œì‹œê¸€ ëª¨ë‹¬ ì—´ê¸°
async function openPostModal(postId) {
    console.log('Opening post modal for postId:', postId);
    try {
        currentPostId = postId;
        
        // ê²Œì‹œê¸€ ìƒì„¸ ì •ë³´ ë¡œë“œ
        const response = await fetch(`/api/v1/board/posts/${postId}`);
        const data = await response.json();
        
        if (response.ok) {
            // ëª¨ë‹¬ ë‚´ìš© ì—…ë°ì´íŠ¸
            document.getElementById('modalTitle').textContent = data.post.title;
            document.getElementById('modalAuthorAvatar').src = data.post.author_avatar;
            document.getElementById('modalAuthorName').textContent = data.post.author_username;
            document.getElementById('modalDate').textContent = formatDate(data.post.created_at);
            document.getElementById('modalViews').textContent = data.post.view_count || 0;
            document.getElementById('modalContent').innerHTML = convertMarkdownToHtml(data.post.content);
            
            // ë­í¬ ë°°ì§€ í‘œì‹œ
            const rankBadge = document.getElementById('modalAuthorRank');
            if (data.post.rank_image) {
                rankBadge.src = `/images/ranks/${data.post.rank_image}`;
                rankBadge.alt = data.post.rank_name;
                rankBadge.title = `${data.post.rank_name} (${data.post.points || 0}ì )`;
                rankBadge.style.display = 'inline';
            } else {
                rankBadge.style.display = 'none';
            }
            
            // ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ í‘œì‹œ ì—¬ë¶€ (ë³¸ì¸ ê¸€ì¸ ê²½ìš°ì—ë§Œ)
            const postActions = document.getElementById('postActions');
            if (data.canEdit) {
                postActions.style.display = 'flex';
            } else {
                postActions.style.display = 'none';
            }
            
            // ëŒ“ê¸€ í‘œì‹œ
            displayComments(data.comments || []);
            
            // ëª¨ë‹¬ í‘œì‹œ
            document.getElementById('postModal').style.display = 'flex';
            document.body.style.overflow = 'hidden'; // ìŠ¤í¬ë¡¤ ë°©ì§€
        } else {
            console.error('ê²Œì‹œê¸€ ë¡œë“œ ì‹¤íŒ¨:', data);
            alert(data.error || 'ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        console.error('ê²Œì‹œê¸€ ë¡œë“œ ì˜¤ë¥˜:', error);
        alert('ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n' + error.message);
    }
}

// ê²Œì‹œê¸€ ëª¨ë‹¬ ë‹«ê¸°
function closePostModal() {
    document.getElementById('postModal').style.display = 'none';
    document.body.style.overflow = 'auto'; // ìŠ¤í¬ë¡¤ ë³µì›
    currentPostId = null;
}

// ëŒ“ê¸€ í‘œì‹œ
function displayComments(comments) {
    console.log('Displaying comments:', comments);
    const commentsList = document.getElementById('commentsList');
    const commentsCount = document.getElementById('commentsCount');
    
    commentsCount.textContent = comments.length;
    
    if (comments.length === 0) {
        commentsList.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
    }
    
    commentsList.innerHTML = comments.map(comment => `
        <div class="comment-item">
            <div class="comment-author">
                <img src="${comment.author_avatar}" alt="${comment.author_username}" class="author-avatar"
                     onerror="this.src='data:image/svg+xml;charset=utf-8,${encodeURIComponent('<svg xmlns=\\\"http://www.w3.org/2000/svg\\\" width=\\\"24\\\" height=\\\"24\\\" viewBox=\\\"0 0 24 24\\\"><circle cx=\\\"12\\\" cy=\\\"12\\\" r=\\\"10\\\" fill=\\\"#666\\\" stroke=\\\"#fff\\\" stroke-width=\\\"2\\\"/><circle cx=\\\"12\\\" cy=\\\"10\\\" r=\\\"3\\\" fill=\\\"#fff\\\"/><path d=\\\"M6.5 17.5 Q12 15 17.5 17.5\\\" stroke=\\\"#fff\\\" stroke-width=\\\"2\\\" fill=\\\"none\\\"/></svg>')}'">
                <span>${escapeHtml(comment.author_username)}</span>
            </div>
            <div class="comment-content">${escapeHtml(comment.content)}</div>
            <div class="comment-date">${formatDate(comment.created_at)}</div>
        </div>
    `).join('');
}

// ëŒ“ê¸€ ì‘ì„±
async function addComment() {
    if (!currentPostId) {
        console.error('No currentPostId');
        return;
    }
    
    const commentInput = document.getElementById('commentInput');
    const content = commentInput.value.trim();
    
    if (!content) {
        alert('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    console.log('Adding comment:', { postId: currentPostId, content });
    
    try {
        const response = await fetch(`/api/v1/board/posts/${currentPostId}/comments`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ content })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            console.log('Comment added successfully:', data);
            commentInput.value = '';
            // ê²Œì‹œê¸€ ë‹¤ì‹œ ë¡œë“œí•´ì„œ ëŒ“ê¸€ ì—…ë°ì´íŠ¸
            openPostModal(currentPostId);
        } else {
            console.error('Comment creation failed:', data);
            alert(data.error || 'ëŒ“ê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        console.error('ëŒ“ê¸€ ì‘ì„± ì˜¤ë¥˜:', error);
        alert('ëŒ“ê¸€ ì‘ì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n' + error.message);
    }
}

// ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
document.getElementById('postModal').addEventListener('click', (e) => {
    if (e.target === document.getElementById('postModal')) {
        closePostModal();
    }
});

// ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && document.getElementById('postModal').style.display === 'flex') {
        closePostModal();
    }
});

// HTML ì´ìŠ¤ì¼€ì´í”„
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ì´ë¯¸ì§€ ì˜¤ë¥˜ ì²˜ë¦¬
function handleImageError(img) {
    img.src = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="#666" stroke="#fff" stroke-width="2"/><circle cx="12" cy="10" r="3" fill="#fff"/><path d="M6.5 17.5 Q12 15 17.5 17.5" stroke="#fff" stroke-width="2" fill="none"/></svg>');
}

// ì´ë¯¸ì§€ì— ì˜¤ë¥˜ í•¸ë“¤ëŸ¬ ì¶”ê°€
function setupImageErrorHandlers() {
    // ëª¨ë“  í”„ë¡œí•„ ì•„ë°”íƒ€ì— ì˜¤ë¥˜ í•¸ë“¤ëŸ¬ ì¶”ê°€
    document.querySelectorAll('.author-avatar, .comment-author-avatar, .post-author-avatar').forEach(img => {
        img.onerror = () => handleImageError(img);
    });
}

// ê²Œì‹œê¸€ ìˆ˜ì •
async function editPost() {
    if (!currentPostId) return;
    
    // í˜„ì¬ ë‚´ìš©ì„ ìˆ˜ì • í¼ì— ë³µì‚¬
    const currentTitle = document.getElementById('modalTitle').textContent;
    const currentContent = document.getElementById('modalContent').textContent;
    
    document.getElementById('editTitle').value = currentTitle;
    document.getElementById('editContent').value = currentContent;
    
    // ì›ë³¸ ë‚´ìš© ìˆ¨ê¸°ê³  ìˆ˜ì • í¼ í‘œì‹œ
    document.getElementById('modalContent').style.display = 'none';
    document.getElementById('editForm').style.display = 'block';
}

// ê²Œì‹œê¸€ ìˆ˜ì • ì·¨ì†Œ
function cancelEdit() {
    document.getElementById('modalContent').style.display = 'block';
    document.getElementById('editForm').style.display = 'none';
}

// ê²Œì‹œê¸€ ìˆ˜ì • ì €ì¥
async function saveEdit() {
    if (!currentPostId) return;
    
    const title = document.getElementById('editTitle').value.trim();
    const content = document.getElementById('editContent').value.trim();
    
    if (!title || !content) {
        alert('ì œëª©ê³¼ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    try {
        const response = await fetch(`/api/v1/board/posts/${currentPostId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ title, content })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            // ëª¨ë‹¬ ë‚´ìš© ì—…ë°ì´íŠ¸
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalContent').innerHTML = convertMarkdownToHtml(content);
            
            // ìˆ˜ì • í¼ ìˆ¨ê¸°ê³  ì›ë³¸ í‘œì‹œ
            cancelEdit();
            
            // ê²Œì‹œê¸€ ëª©ë¡ë„ ì—…ë°ì´íŠ¸
            loadPosts(currentPage);
            
            alert('ê²Œì‹œê¸€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } else {
            alert(data.error || 'ê²Œì‹œê¸€ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        console.error('ê²Œì‹œê¸€ ìˆ˜ì • ì˜¤ë¥˜:', error);
        alert('ê²Œì‹œê¸€ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

// ê²Œì‹œê¸€ ì‚­ì œ
async function deletePost() {
    if (!currentPostId) return;
    
    if (!confirm('ì •ë§ë¡œ ì´ ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/v1/board/posts/${currentPostId}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (response.ok) {
            // ëª¨ë‹¬ ë‹«ê¸°
            closePostModal();
            
            // ê²Œì‹œê¸€ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            loadPosts(currentPage);
            
            alert('ê²Œì‹œê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        } else {
            alert(data.error || 'ê²Œì‹œê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        console.error('ê²Œì‹œê¸€ ì‚­ì œ ì˜¤ë¥˜:', error);
        alert('ê²Œì‹œê¸€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

// ì´ë¯¸ì§€ ì—…ë¡œë“œ ê´€ë ¨ ë³€ìˆ˜
let uploadedImageUrl = null;

// ì´ë¯¸ì§€ ì—…ë¡œë“œ ê¸°ëŠ¥ ì´ˆê¸°í™”
function initImageUpload() {
    const imageUploadBtn = document.getElementById('imageUploadBtn');
    const imageUpload = document.getElementById('imageUpload');
    const imagePreviewContainer = document.getElementById('imagePreviewContainer');
    const imagePreview = document.getElementById('imagePreview');
    const removeImageBtn = document.getElementById('removeImageBtn');
    const uploadProgress = document.getElementById('uploadProgress');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');

    // ì´ë¯¸ì§€ ì„ íƒ ë²„íŠ¼ í´ë¦­
    imageUploadBtn.addEventListener('click', () => {
        imageUpload.click();
    });

    // íŒŒì¼ ì„ íƒ ì‹œ
    imageUpload.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        // íŒŒì¼ í¬ê¸° ì²´í¬ (5MB)
        if (file.size > 5 * 1024 * 1024) {
            alert('íŒŒì¼ í¬ê¸°ëŠ” 5MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.');
            return;
        }

        // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
        const reader = new FileReader();
        reader.onload = (e) => {
            imagePreview.src = e.target.result;
            imagePreviewContainer.style.display = 'block';
        };
        reader.readAsDataURL(file);

        // ì—…ë¡œë“œ ì§„í–‰ë¥  í‘œì‹œ
        uploadProgress.style.display = 'block';
        progressFill.style.width = '0%';
        progressText.textContent = 'ì—…ë¡œë“œ ì¤‘...';

        try {
            // ì´ë¯¸ì§€ ì—…ë¡œë“œ
            const formData = new FormData();
            formData.append('image', file);

            const xhr = new XMLHttpRequest();
            
            // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
            xhr.upload.onprogress = (e) => {
                if (e.lengthComputable) {
                    const percentComplete = (e.loaded / e.total) * 100;
                    progressFill.style.width = percentComplete + '%';
                    progressText.textContent = `ì—…ë¡œë“œ ì¤‘... ${Math.round(percentComplete)}%`;
                }
            };

            xhr.onload = () => {
                uploadProgress.style.display = 'none';
                
                if (xhr.status === 200) {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        if (response.success) {
                            uploadedImageUrl = response.url;
                            progressText.textContent = 'ì—…ë¡œë“œ ì™„ë£Œ!';
                            console.log('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì„±ê³µ:', response.url);
                        } else {
                            console.error('ì—…ë¡œë“œ ì‹¤íŒ¨ ì‘ë‹µ:', response);
                            alert('ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (response.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                            if (response.details) {
                                console.error('ì„¸ë¶€ì‚¬í•­:', response.details);
                            }
                            removeImage();
                        }
                    } catch (parseError) {
                        console.error('ì‘ë‹µ íŒŒì‹± ì˜¤ë¥˜:', parseError);
                        console.error('ì„œë²„ ì‘ë‹µ:', xhr.responseText);
                        alert('ì„œë²„ ì‘ë‹µì„ ì²˜ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        removeImage();
                    }
                } else {
                    console.error('HTTP ì˜¤ë¥˜:', xhr.status, xhr.statusText);
                    console.error('ì‘ë‹µ ë‚´ìš©:', xhr.responseText);
                    alert(`ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤ (${xhr.status}): ${xhr.statusText}`);
                    removeImage();
                }
            };

            xhr.onerror = () => {
                uploadProgress.style.display = 'none';
                alert('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                removeImage();
            };

            xhr.open('POST', '/api/v1/upload/image');
            xhr.send(formData);

        } catch (error) {
            console.error('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
            alert('ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            removeImage();
        }
    });

    // ì´ë¯¸ì§€ ì œê±°
    removeImageBtn.addEventListener('click', removeImage);

    function removeImage() {
        imagePreviewContainer.style.display = 'none';
        imagePreview.src = '';
        imageUpload.value = '';
        uploadedImageUrl = null;
        uploadProgress.style.display = 'none';
    }
}

// ê²Œì‹œê¸€ ì‘ì„± ì‹œ ì´ë¯¸ì§€ URL í¬í•¨
function getPostContent() {
    const content = document.getElementById('postContent').value;
    if (uploadedImageUrl) {
        return content + '\n\n![ì´ë¯¸ì§€](' + uploadedImageUrl + ')';
    }
    return content;
}

// ë§ˆí¬ë‹¤ìš´ ì´ë¯¸ì§€ë¥¼ HTMLë¡œ ë³€í™˜
function convertMarkdownToHtml(content) {
    if (!content) return '';
    
    // ë§ˆí¬ë‹¤ìš´ ì´ë¯¸ì§€ íŒ¨í„´ ![alt](url) ë¥¼ HTML <img> íƒœê·¸ë¡œ ë³€í™˜
    return content.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, alt, url) {
        return `<div class="image-container"><img src="${url}" alt="${alt}" style="max-width: 100%; height: auto; border-radius: 8px; margin: 10px 0; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);"></div>`;
    });
}

// ë‚ ì§œ í¬ë§·íŒ…
function formatDate(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diff = now - date;
    
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);
    
    if (minutes < 1) return 'ë°©ê¸ˆ ì „';
    if (minutes < 60) return `${minutes}ë¶„ ì „`;
    if (hours < 24) return `${hours}ì‹œê°„ ì „`;
    if (days < 7) return `${days}ì¼ ì „`;
    
    return date.toLocaleDateString('ko-KR');
}
</script>
<div class="player-detail-section">
    <div class="player-detail-container">
        <!-- Loading State -->
        <div class="player-loading" id="player-loading">
            <div class="loading-spinner"></div>
            <p>플레이어 정보를 불러오는 중...</p>
        </div>

        <!-- Player Content -->
        <div class="player-content" id="player-content" style="display: none;">
            <!-- Player Header -->
            <div class="player-header">
                <div class="player-basic-info">
                    <img class="player-detail-avatar" id="player-avatar" alt="Player Avatar">
                    <div class="player-main-info">
                        <h1 class="player-name" id="player-name">플레이어</h1>
                        <div class="player-meta">
                            <div class="account-info">
                                <span class="player-account-flag" id="player-account-flag">🌍</span>
                                <span class="player-account-id">계정 ID: <%= accountId %></span>
                            </div>
                            <span class="player-steam-id" id="player-steam-id">Steam ID: 76561198015042012</span>
                        </div>
                    </div>
                </div>
                <div class="player-rank">
                    <div class="rank-badge">
                        <img class="rank-medal" id="rank-medal" alt="Rank Medal">
                        <div class="rank-info">
                            <span class="rank-name" id="rank-name">랭크 정보 없음</span>
                            <span class="rank-score" id="rank-score">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Player Stats -->
            <div class="player-stats">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="stat-matches">0</div>
                        <div class="stat-label">매치</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-winrate">0%</div>
                        <div class="stat-label">승률</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-lane-winrate">0%</div>
                        <div class="stat-label">라인 승률</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-kda">0.0</div>
                        <div class="stat-label">KDA</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-headshots">0%</div>
                        <div class="stat-label">헤드샷</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-souls">0</div>
                        <div class="stat-label">소울/분</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-damage">0</div>
                        <div class="stat-label">총 디나이</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-healing">0</div>
                        <div class="stat-label">추천수</div>
                    </div>
                </div>
            </div>

            <!-- Party Members Section -->
            <div class="player-section">
                <h2 class="section-title">함께 플레이한 팀원</h2>
                <div class="party-members-list" id="party-members-list">
                    <!-- Party members will be populated by JavaScript -->
                </div>
            </div>

            <!-- Heroes Section -->
            <div class="player-section">
                <h2 class="section-title">플레이한 영웅</h2>
                <div class="heroes-grid" id="heroes-grid">
                    <!-- Heroes will be populated by JavaScript -->
                </div>
            </div>

            <!-- Recent Matches -->
            <div class="player-section">
                <h2 class="section-title">최근 매치</h2>
                <div class="matches-list" id="matches-list">
                    <!-- Matches will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Error State -->
        <div class="player-error" id="player-error" style="display: none;">
            <h2>플레이어를 찾을 수 없습니다</h2>
            <p>요청하신 플레이어 정보를 불러올 수 없습니다.</p>
            <a href="/ko/leaderboards/asia" class="back-button">리더보드로 돌아가기</a>
        </div>
    </div>
</div>

<style>
/* Player Detail Styles */
.player-detail-section {
    padding: 120px 0 60px;
    min-height: 100vh;
    background: #000000;
}

.player-detail-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 40px;
}

.player-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 100px 20px;
    color: #FFEFD7;
}

.player-content {
    color: #FFEFD7;
}

.player-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(255, 255, 255, 0.05);
    padding: 40px;
    border-radius: 16px;
    margin-bottom: 40px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.player-basic-info {
    display: flex;
    align-items: center;
    gap: 30px;
}

.player-detail-avatar {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    border: 3px solid #63a2e2;
    box-shadow: 0 4px 20px rgba(99, 162, 226, 0.3);
}

.player-main-info {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.player-name {
    font-size: 36px;
    font-weight: 700;
    color: #FFEFD7;
    margin: 0;
}

.player-meta {
    display: flex;
    flex-direction: column;
    gap: 8px;
    font-size: 16px;
}

.account-info {
    display: flex;
    align-items: center;
    gap: 8px;
}

.player-account-flag {
    font-size: 18px;
}

.player-account-id {
    color: #999;
    font-size: 14px;
}

.player-steam-id {
    color: #999;
    font-size: 14px;
}

.flag-image {
    width: 24px;
    height: 18px;
    object-fit: cover;
    border-radius: 2px;
    vertical-align: middle;
}

.player-rank {
    display: flex;
    align-items: center;
}

.rank-badge {
    display: flex;
    align-items: center;
    gap: 15px;
    background: rgba(99, 162, 226, 0.1);
    padding: 20px 30px;
    border-radius: 12px;
    border: 2px solid #63a2e2;
}

.rank-medal {
    width: 60px;
    height: 60px;
}

.rank-info {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.rank-name {
    font-size: 18px;
    font-weight: 600;
    color: #63a2e2;
}

.rank-score {
    font-size: 24px;
    font-weight: 700;
    color: #FFEFD7;
}

.player-stats {
    background: rgba(255, 255, 255, 0.05);
    padding: 40px;
    border-radius: 16px;
    margin-bottom: 40px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 30px;
}

.stat-card {
    text-align: center;
    padding: 20px;
    background: rgba(255, 255, 255, 0.03);
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.3s;
}

.stat-card:hover {
    background: rgba(99, 162, 226, 0.1);
    border-color: #63a2e2;
    transform: translateY(-2px);
}

.stat-value {
    font-size: 28px;
    font-weight: 700;
    color: #63a2e2;
    margin-bottom: 8px;
}

.stat-label {
    font-size: 14px;
    color: #999;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.player-section {
    background: rgba(255, 255, 255, 0.05);
    padding: 40px;
    border-radius: 16px;
    margin-bottom: 40px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.section-title {
    font-size: 24px;
    font-weight: 600;
    color: #FFEFD7;
    margin-bottom: 30px;
    border-bottom: 2px solid #63a2e2;
    padding-bottom: 10px;
}

.heroes-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
}

.hero-card {
    display: flex;
    align-items: center;
    gap: 15px;
    background: rgba(255, 255, 255, 0.03);
    padding: 20px;
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.3s;
}

.hero-card:hover {
    background: rgba(99, 162, 226, 0.1);
    border-color: #63a2e2;
    transform: translateY(-2px);
}

.hero-card-image {
    width: 50px;
    height: 50px;
    border-radius: 8px;
}

.hero-card-info h3 {
    font-size: 16px;
    font-weight: 600;
    color: #FFEFD7;
    margin: 0 0 5px 0;
}

.hero-card-stats {
    font-size: 14px;
    color: #999;
}

.hero-stat-line {
    margin-bottom: 4px;
}

.hero-kda-line {
    font-size: 12px;
    color: #63a2e2;
    font-weight: 600;
}

.matches-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.match-card {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: rgba(255, 255, 255, 0.03);
    padding: 20px;
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.3s;
}

.match-card:hover {
    background: rgba(99, 162, 226, 0.1);
    border-color: #63a2e2;
}

.match-card.win {
    border-left: 4px solid #10B981;
}

.match-card.loss {
    border-left: 4px solid #EF4444;
}

.match-hero {
    display: flex;
    align-items: center;
    gap: 15px;
}

.match-hero-image {
    width: 40px;
    height: 40px;
    border-radius: 6px;
}

.match-result {
    font-weight: 600;
}

.match-result.win {
    color: #10B981;
}

.match-result.loss {
    color: #EF4444;
}

.match-kda {
    font-family: monospace;
    font-size: 16px;
    color: #FFEFD7;
}

.match-stats {
    display: flex;
    gap: 20px;
    font-size: 14px;
    color: #999;
}

.match-items {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.items-label {
    font-size: 12px;
    color: #999;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 10px;
    text-align: center;
}

.items-grid {
    display: flex;
    gap: 8px;
    justify-content: center;
    flex-wrap: wrap;
}

.item-image {
    width: 44px;
    height: 44px;
    border-radius: 6px;
    object-fit: cover;
    border: 1px solid rgba(255, 255, 255, 0.2);
    transition: all 0.3s;
    cursor: pointer;
}

/* 데드락 아이템 타입별 스타일 */
.item-wrapper {
    position: relative;
    display: inline-block;
    margin: 2px;
}

.weapon-item {
    border-color: #FF6B35 !important;
    box-shadow: 0 0 8px rgba(255, 107, 53, 0.3);
}

.vitality-item {
    border-color: #4CAF50 !important;
    box-shadow: 0 0 8px rgba(76, 175, 80, 0.3);
}

.spirit-item {
    border-color: #9C27B0 !important;
    box-shadow: 0 0 8px rgba(156, 39, 176, 0.3);
}

.unknown-item {
    border-color: #ff6b6b !important;
    box-shadow: 0 0 8px rgba(255, 107, 107, 0.3);
    animation: pulse-red 2s infinite;
}

.fallback-item {
    border-color: #ffd93d !important;
    box-shadow: 0 0 8px rgba(255, 217, 61, 0.3);
}

.unknown-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #ff6b6b;
    color: white;
    border-radius: 50%;
    width: 16px;
    height: 16px;
    font-size: 10px;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1;
}

@keyframes pulse-red {
    0% { box-shadow: 0 0 8px rgba(255, 107, 107, 0.3); }
    50% { box-shadow: 0 0 15px rgba(255, 107, 107, 0.6); }
    100% { box-shadow: 0 0 8px rgba(255, 107, 107, 0.3); }
}

/* 아이템 호버 효과 개선 */
.item-image:hover {
    transform: scale(1.1);
    z-index: 10;
    position: relative;
}

/* 아이템 그리드 개선 */
.items-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    align-items: center;
    justify-content: flex-start;
    max-width: 100%;
}

@media (max-width: 768px) {
    .item-image {
        width: 40px;
        height: 40px;
    }
    
    .unknown-badge {
        width: 14px;
        height: 14px;
        font-size: 9px;
    }
}

/* Deadlock 프로필 초기화 함수 */
async function initializeDeadlockProfile() {
    try {
        console.log('🎮 데드락 프로필 시스템 초기화 중...');
        
        // 아이템 매니저 캐시 워밍업
        const commonItems = [
            'Basic Magazine', 'Extra Health', 'Extra Spirit', 'Bullet Armor', 
            'Spirit Armor', 'Metal Skin', 'Mystic Burst', 'Tesla Bullets',
            'Colossus', 'Echo Shard', 'Refresher', 'Glass Cannon'
        ];
        
        commonItems.forEach(itemName => {
            itemManager.getItemData(itemName);
        });
        
        console.log('✅ 데드락 프로필 시스템 초기화 완료');
        console.log(`📦 아이템 캐시: ${itemManager.itemCache.size}개 아이템 로드됨`);
        
    } catch (error) {
        console.error('❌ 데드락 프로필 초기화 실패:', error);
    }
}

// 페이지 로드시 초기화
document.addEventListener('DOMContentLoaded', () => {
    initializeDeadlockProfile();
});
    box-shadow: 0 2px 8px rgba(99, 162, 226, 0.3);
}

.party-members-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.party-member-card {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: rgba(255, 255, 255, 0.03);
    padding: 20px;
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.3s;
}

.party-member-card:hover {
    background: rgba(99, 162, 226, 0.1);
    border-color: #63a2e2;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(99, 162, 226, 0.2);
}

.party-member-card:active {
    transform: translateY(0px) scale(0.98);
    box-shadow: 0 2px 8px rgba(99, 162, 226, 0.15);
}

.party-member-info {
    display: flex;
    align-items: center;
    gap: 15px;
}

.party-member-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    border: 2px solid #63a2e2;
}

.party-member-details h3 {
    font-size: 16px;
    font-weight: 600;
    color: #FFEFD7;
    margin: 0 0 5px 0;
}

.party-member-matches {
    font-size: 14px;
    color: #999;
    margin-bottom: 5px;
}

.party-member-rank {
    display: flex;
    align-items: center;
    gap: 6px;
}

.rank-badge-small {
    width: 20px;
    height: 20px;
    border-radius: 50%;
}

.rank-text {
    font-size: 12px;
    color: #63a2e2;
    font-weight: 500;
}

.party-member-stats {
    display: flex;
    gap: 30px;
    align-items: center;
}

.party-stat-item {
    text-align: center;
}

.party-stat-item .label {
    font-size: 12px;
    color: #999;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 5px;
}

.party-stat-item .value {
    font-size: 16px;
    font-weight: 600;
    color: #FFEFD7;
}

.party-win-rate {
    font-size: 18px;
    font-weight: 700;
    color: #10B981;
}

.party-kda {
    font-family: monospace;
    font-size: 14px;
    color: #FFEFD7;
}

.party-member-heroes {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.heroes-label {
    font-size: 12px;
    color: #999;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 10px;
    text-align: center;
}

.heroes-list {
    display: flex;
    gap: 15px;
    justify-content: center;
}

.hero-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
}

.hero-mini-image {
    width: 40px;
    height: 40px;
    border-radius: 6px;
    object-fit: cover;
}

.hero-mini-stats {
    text-align: center;
}

.hero-name {
    font-size: 10px;
    color: #FFEFD7;
    font-weight: 500;
    white-space: nowrap;
}

.hero-winrate {
    font-size: 9px;
    color: #10B981;
    font-weight: 500;
}

.player-error {
    text-align: center;
    padding: 100px 20px;
    color: #FFEFD7;
}

.player-error h2 {
    font-size: 36px;
    margin-bottom: 20px;
    color: #EF4444;
}

.back-button {
    display: inline-block;
    background: #63a2e2;
    color: white;
    padding: 12px 24px;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
    margin-top: 20px;
    transition: all 0.3s;
}

.back-button:hover {
    background: #4f8bc9;
    transform: translateY(-2px);
}

/* Responsive */
@media (max-width: 768px) {
    .player-detail-container {
        padding: 0 20px;
    }
    
    .player-header {
        flex-direction: column;
        gap: 30px;
        text-align: center;
    }
    
    .player-basic-info {
        flex-direction: column;
        text-align: center;
    }
    
    .player-name {
        font-size: 28px;
    }
    
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
    }
    
    .heroes-grid {
        grid-template-columns: 1fr;
    }
    
    .match-card {
        flex-direction: column;
        gap: 15px;
        text-align: center;
    }
    
    .items-grid {
        gap: 6px;
    }
    
    .item-image {
        width: 40px;
        height: 40px;
    }
}
</style>

<script>
// 국가 플래그를 이미지로 변환하는 함수
function getCountryImage(countryFlag) {
    const flagImageMap = {
        '🇺🇸': '<img src="https://flagcdn.com/24x18/us.png" alt="미국" title="미국" class="flag-image">',
        '🇨🇦': '<img src="https://flagcdn.com/24x18/ca.png" alt="캐나다" title="캐나다" class="flag-image">',
        '🇲🇽': '<img src="https://flagcdn.com/24x18/mx.png" alt="멕시코" title="멕시코" class="flag-image">',
        '🇬🇧': '<img src="https://flagcdn.com/24x18/gb.png" alt="영국" title="영국" class="flag-image">',
        '🇩🇪': '<img src="https://flagcdn.com/24x18/de.png" alt="독일" title="독일" class="flag-image">',
        '🇫🇷': '<img src="https://flagcdn.com/24x18/fr.png" alt="프랑스" title="프랑스" class="flag-image">',
        '🇪🇸': '<img src="https://flagcdn.com/24x18/es.png" alt="스페인" title="스페인" class="flag-image">',
        '🇮🇹': '<img src="https://flagcdn.com/24x18/it.png" alt="이탈리아" title="이탈리아" class="flag-image">',
        '🇨🇳': '<img src="https://flagcdn.com/24x18/cn.png" alt="중국" title="중국" class="flag-image">',
        '🇯🇵': '<img src="https://flagcdn.com/24x18/jp.png" alt="일본" title="일본" class="flag-image">',
        '🇰🇷': '<img src="https://flagcdn.com/24x18/kr.png" alt="한국" title="한국" class="flag-image">',
        '🇹🇼': '<img src="https://flagcdn.com/24x18/tw.png" alt="대만" title="대만" class="flag-image">',
        '🇸🇬': '<img src="https://flagcdn.com/24x18/sg.png" alt="싱가포르" title="싱가포르" class="flag-image">',
        '🇷🇺': '<img src="https://flagcdn.com/24x18/ru.png" alt="러시아" title="러시아" class="flag-image">',
        '🇵🇱': '<img src="https://flagcdn.com/24x18/pl.png" alt="폴란드" title="폴란드" class="flag-image">',
        '🇸🇪': '<img src="https://flagcdn.com/24x18/se.png" alt="스웨덴" title="스웨덴" class="flag-image">',
        '🇳🇴': '<img src="https://flagcdn.com/24x18/no.png" alt="노르웨이" title="노르웨이" class="flag-image">',
        '🇩🇰': '<img src="https://flagcdn.com/24x18/dk.png" alt="덴마크" title="덴마크" class="flag-image">',
        '🇹🇭': '<img src="https://flagcdn.com/24x18/th.png" alt="태국" title="태국" class="flag-image">',
        '🇻🇳': '<img src="https://flagcdn.com/24x18/vn.png" alt="베트남" title="베트남" class="flag-image">',
        '🇲🇾': '<img src="https://flagcdn.com/24x18/my.png" alt="말레이시아" title="말레이시아" class="flag-image">',
        '🇵🇭': '<img src="https://flagcdn.com/24x18/ph.png" alt="필리핀" title="필리핀" class="flag-image">',
        '🇮🇩': '<img src="https://flagcdn.com/24x18/id.png" alt="인도네시아" title="인도네시아" class="flag-image">',
        '🌍': '<img src="https://flagcdn.com/24x18/un.png" alt="알 수 없음" title="알 수 없음" class="flag-image">'
    };
    
    return flagImageMap[countryFlag] || '<img src="https://flagcdn.com/24x18/un.png" alt="알 수 없음" title="알 수 없음" class="flag-image">';
}

let currentPlayer = null;

async function loadPlayerData() {
    const loading = document.getElementById('player-loading');
    const content = document.getElementById('player-content');
    const error = document.getElementById('player-error');
    
    loading.style.display = 'flex';
    content.style.display = 'none';
    error.style.display = 'none';
    
    try {
        const response = await fetch(`/api/v1/players/<%= accountId %>`);
        const data = await response.json();
        
        if (response.ok) {
            currentPlayer = data;
            updatePlayerUI(data);
            loading.style.display = 'none';
            content.style.display = 'block';
        } else {
            throw new Error(data.error || 'Failed to load player');
        }
        
    } catch (err) {
        console.error('Failed to load player data:', err);
        loading.style.display = 'none';
        error.style.display = 'block';
    }
}

function updatePlayerUI(player) {
    // Basic Info
    document.getElementById('player-avatar').src = player.avatar;
    document.getElementById('player-name').textContent = player.name;
    document.getElementById('player-account-flag').innerHTML = getCountryImage(player.country);
    
    // Steam ID - display dynamically if available
    if (player.steamId) {
        document.getElementById('player-steam-id').textContent = `Steam ID: ${player.steamId}`;
    }
    
    // Rank - 리더보드와 동일한 매핑 사용
    const getMedalImage = (medal, subrank) => {
        const medalRankMap = {
            'eternus': 11,
            'phantom': 10,
            'oracle': 9,
            'ritualist': 8,
            'alchemist': 7,
            'arcanist': 6,
            'initiate': 5
        };
        
        const rankNumber = medalRankMap[medal?.toLowerCase()] || 5;
        const subrankFormatted = subrank || 1;
        
        return `https://cdn.deadlock.coach/vpk/panorama/images/ranked/badges/rank${rankNumber}/badge_sm_subrank${subrankFormatted}.webp`;
    };
    
    // 한글 메달명 변환 함수
    const getKoreanMedal = (englishMedal) => {
        const medalTranslation = {
            'Eternus': '이터누스',
            'Phantom': '팬텀',
            'Oracle': '오라클',
            'Ritualist': '리츄얼리스트',
            'Alchemist': '알케미스트',
            'Arcanist': '아케니스트',
            'Initiate': '탐험가'
        };
        return medalTranslation[englishMedal] || englishMedal;
    };
    
    if (player.rank?.medal && player.rank?.subrank && player.rank?.score) {
        document.getElementById('rank-medal').src = getMedalImage(player.rank.medal, player.rank.subrank);
        document.getElementById('rank-name').textContent = `${getKoreanMedal(player.rank.medal)} ${player.rank.subrank}`;
        document.getElementById('rank-score').textContent = player.rank.score.toLocaleString();
    } else {
        document.getElementById('rank-medal').src = getMedalImage('Initiate', 1);
        document.getElementById('rank-name').textContent = '랭크 정보 없음';
        document.getElementById('rank-score').textContent = '-';
    }
    
    // Stats
    console.log('Player stats:', player.stats);
    document.getElementById('stat-matches').textContent = player.stats.matches || 0;
    document.getElementById('stat-winrate').textContent = `${player.stats.winRate || 0}%`;
    document.getElementById('stat-lane-winrate').textContent = `${player.stats.laneWinRate || 0}%`;
    document.getElementById('stat-kda').textContent = player.stats.kda || '0.0';
    document.getElementById('stat-headshots').textContent = `${player.stats.headshotPercent || 0}%`;
    document.getElementById('stat-souls').textContent = (player.stats.soulsPerMin || 0).toLocaleString();
    document.getElementById('stat-damage').textContent = (player.stats.denies || 0).toLocaleString();
    document.getElementById('stat-healing').textContent = (player.stats.endorsements || 0).toLocaleString();
    
    // Party Members
    loadPartyMembers();
    
    // Heroes
    updateHeroesGrid(player.heroes);
    
    // Recent Matches
    updateMatchesList(player.recentMatches);
}

// 데드락 아이템 관리 시스템
class DeadlockItemManager {
    constructor() {
        this.itemCache = new Map();
        this.initialized = false;
        this.fallbackItems = this.initializeFallbackItems();
    }

    initializeFallbackItems() {
        return {
            // Weapon Items (주황색)
            'weapon': {
                'Basic Magazine': { type: 'weapon', tier: 1, color: '#FF6B35' },
                'Close Quarters': { type: 'weapon', tier: 1, color: '#FF6B35' },
                'Headshot Booster': { type: 'weapon', tier: 1, color: '#FF6B35' },
                'High-Velocity Mag': { type: 'weapon', tier: 1, color: '#FF6B35' },
                'Monster Rounds': { type: 'weapon', tier: 1, color: '#FF6B35' },
                'Rapid Rounds': { type: 'weapon', tier: 1, color: '#FF6B35' },
                'Hollow Point Ward': { type: 'weapon', tier: 1, color: '#FF6B35' },
                'Restorative Shot': { type: 'weapon', tier: 1, color: '#FF6B35' },
                'Active Reload': { type: 'weapon', tier: 2, color: '#FF8C42' },
                'Berserker': { type: 'weapon', tier: 2, color: '#FF8C42' },
                'Escalating Resilience': { type: 'weapon', tier: 2, color: '#FF8C42' },
                'Fleetfoot': { type: 'weapon', tier: 2, color: '#FF8C42' },
                "Hunter's Aura": { type: 'weapon', tier: 2, color: '#FF8C42' },
                'Kinetic Dash': { type: 'weapon', tier: 2, color: '#FF8C42' },
                'Long Range': { type: 'weapon', tier: 2, color: '#FF8C42' },
                'Melee Charge': { type: 'weapon', tier: 2, color: '#FF8C42' },
                'Mystic Shot': { type: 'weapon', tier: 2, color: '#FF8C42' },
                'Point Blank': { type: 'weapon', tier: 2, color: '#FF8C42' },
                'Pristine Emblem': { type: 'weapon', tier: 2, color: '#FF8C42' },
                'Sharpshooter': { type: 'weapon', tier: 2, color: '#FF8C42' },
                'Soul Shredder Bullets': { type: 'weapon', tier: 2, color: '#FF8C42' },
                'Surge of Power': { type: 'weapon', tier: 2, color: '#FF8C42' },
                'Tesla Bullets': { type: 'weapon', tier: 2, color: '#FF8C42' },
                'Titanic Magazine': { type: 'weapon', tier: 2, color: '#FF8C42' },
                'Toxic Bullets': { type: 'weapon', tier: 2, color: '#FF8C42' },
                'Vampiric Burst': { type: 'weapon', tier: 2, color: '#FF8C42' },
                'Warp Stone': { type: 'weapon', tier: 2, color: '#FF8C42' },
                'Alchemical Fire': { type: 'weapon', tier: 3, color: '#FFAD5A' },
                'Burst Fire': { type: 'weapon', tier: 3, color: '#FFAD5A' },
                'Crippling Headshot': { type: 'weapon', tier: 3, color: '#FFAD5A' },
                'Frenzy': { type: 'weapon', tier: 3, color: '#FFAD5A' },
                'Glass Cannon': { type: 'weapon', tier: 3, color: '#FFAD5A' },
                'Inhibitor': { type: 'weapon', tier: 3, color: '#FFAD5A' },
                'Leech': { type: 'weapon', tier: 3, color: '#FFAD5A' },
                'Lucky Shot': { type: 'weapon', tier: 3, color: '#FFAD5A' },
                'Richochet': { type: 'weapon', tier: 3, color: '#FFAD5A' },
                'Spiritual Overflow': { type: 'weapon', tier: 3, color: '#FFAD5A' },
                'Torment Pulse': { type: 'weapon', tier: 3, color: '#FFAD5A' },
                'Wrecker': { type: 'weapon', tier: 3, color: '#FFAD5A' }
            },
            // Vitality Items (초록색)
            'vitality': {
                'Extra Health': { type: 'vitality', tier: 1, color: '#4CAF50' },
                'Extra Regen': { type: 'vitality', tier: 1, color: '#4CAF50' },
                'Extra Stamina': { type: 'vitality', tier: 1, color: '#4CAF50' },
                'Melee Lifesteal': { type: 'vitality', tier: 1, color: '#4CAF50' },
                'Sprint Boots': { type: 'vitality', tier: 1, color: '#4CAF50' },
                'Healing Rite': { type: 'vitality', tier: 1, color: '#4CAF50' },
                'Bullet Armor': { type: 'vitality', tier: 1, color: '#4CAF50' },
                'Spirit Armor': { type: 'vitality', tier: 1, color: '#4CAF50' },
                'Enduring Speed': { type: 'vitality', tier: 2, color: '#66BB6A' },
                'Reactive Barrier': { type: 'vitality', tier: 2, color: '#66BB6A' },
                'Debuff Remover': { type: 'vitality', tier: 2, color: '#66BB6A' },
                'Divine Barrier': { type: 'vitality', tier: 2, color: '#66BB6A' },
                "Enchanter's Barrier": { type: 'vitality', tier: 2, color: '#66BB6A' },
                'Healing Booster': { type: 'vitality', tier: 2, color: '#66BB6A' },
                'Return Fire': { type: 'vitality', tier: 2, color: '#66BB6A' },
                'Rescue Beam': { type: 'vitality', tier: 2, color: '#66BB6A' },
                'Combat Barrier': { type: 'vitality', tier: 2, color: '#66BB6A' },
                'Improved Bullet Armor': { type: 'vitality', tier: 2, color: '#66BB6A' },
                'Improved Spirit Armor': { type: 'vitality', tier: 2, color: '#66BB6A' },
                'Superior Stamina': { type: 'vitality', tier: 2, color: '#66BB6A' },
                'Veil Walker': { type: 'vitality', tier: 2, color: '#66BB6A' },
                'Fortitude': { type: 'vitality', tier: 3, color: '#81C784' },
                'Lifestrike': { type: 'vitality', tier: 3, color: '#81C784' },
                'Metal Skin': { type: 'vitality', tier: 3, color: '#81C784' },
                'Phantom Strike': { type: 'vitality', tier: 3, color: '#81C784' },
                'Restorative Locket': { type: 'vitality', tier: 3, color: '#81C784' },
                'Superior Duration': { type: 'vitality', tier: 3, color: '#81C784' },
                'Unstoppable': { type: 'vitality', tier: 3, color: '#81C784' },
                'Colossus': { type: 'vitality', tier: 3, color: '#81C784' },
                'Leviathan': { type: 'vitality', tier: 3, color: '#81C784' },
                'Majestic Leap': { type: 'vitality', tier: 3, color: '#81C784' },
                'Soul Rebirth': { type: 'vitality', tier: 3, color: '#81C784' }
            },
            // Spirit Items (보라색)
            'spirit': {
                'Extra Spirit': { type: 'spirit', tier: 1, color: '#9C27B0' },
                'Spirit Strike': { type: 'spirit', tier: 1, color: '#9C27B0' },
                'Mystic Burst': { type: 'spirit', tier: 1, color: '#9C27B0' },
                'Ammo Scavenger': { type: 'spirit', tier: 1, color: '#9C27B0' },
                'Infuser': { type: 'spirit', tier: 1, color: '#9C27B0' },
                'Spirit Lifesteal': { type: 'spirit', tier: 1, color: '#9C27B0' },
                'Cold Front': { type: 'spirit', tier: 1, color: '#9C27B0' },
                'Decay': { type: 'spirit', tier: 1, color: '#9C27B0' },
                'Slowing Hex': { type: 'spirit', tier: 1, color: '#9C27B0' },
                'Superior Cooldown': { type: 'spirit', tier: 1, color: '#9C27B0' },
                'Improved Burst': { type: 'spirit', tier: 2, color: '#BA68C8' },
                'Improved Reach': { type: 'spirit', tier: 2, color: '#BA68C8' },
                'Improved Spirit': { type: 'spirit', tier: 2, color: '#BA68C8' },
                'Mystic Vulnerability': { type: 'spirit', tier: 2, color: '#BA68C8' },
                'Quicksilver Reload': { type: 'spirit', tier: 2, color: '#BA68C8' },
                'Withering Whip': { type: 'spirit', tier: 2, color: '#BA68C8' },
                'Escalating Exposure': { type: 'spirit', tier: 2, color: '#BA68C8' },
                'Ethereal Shift': { type: 'spirit', tier: 2, color: '#BA68C8' },
                'Knockdown': { type: 'spirit', tier: 2, color: '#BA68C8' },
                'Magic Carpet': { type: 'spirit', tier: 2, color: '#BA68C8' },
                'Rapid Recharge': { type: 'spirit', tier: 2, color: '#BA68C8' },
                'Silence Glyph': { type: 'spirit', tier: 2, color: '#BA68C8' },
                'Boundless Spirit': { type: 'spirit', tier: 3, color: '#CE93D8' },
                "Diviner's Kevlar": { type: 'spirit', tier: 3, color: '#CE93D8' },
                'Echo Shard': { type: 'spirit', tier: 3, color: '#CE93D8' },
                'Mystic Reverb': { type: 'spirit', tier: 3, color: '#CE93D8' },
                'Refresher': { type: 'spirit', tier: 3, color: '#CE93D8' }
            }
        };
    }

    getItemData(itemName) {
        // 캐시에서 먼저 확인
        if (this.itemCache.has(itemName)) {
            return this.itemCache.get(itemName);
        }

        // Unknown Item (ID) 형태 처리
        let actualItemName = itemName;
        if (itemName && itemName.startsWith('Unknown Item (') && itemName.endsWith(')')) {
            const itemId = itemName.match(/Unknown Item \((\d+)\)/)?.[1];
            if (itemId) {
                actualItemName = this.getItemNameById(parseInt(itemId));
                console.log(`🔄 아이템 ID 매핑: ${itemName} → ${actualItemName}`);
            }
        }

        // Fallback 데이터에서 검색
        for (const category of Object.values(this.fallbackItems)) {
            if (category[actualItemName]) {
                const itemData = {
                    name: actualItemName,
                    ...category[actualItemName],
                    image: this.getItemImageUrl(actualItemName)
                };
                this.itemCache.set(itemName, itemData);
                return itemData;
            }
        }

        // Unknown Item 처리
        const unknownItem = {
            name: actualItemName,
            type: 'unknown',
            tier: 1,
            color: '#666666',
            image: this.getItemImageUrl('Basic Magazine') // 기본 이미지
        };
        this.itemCache.set(itemName, unknownItem);
        return unknownItem;
    }

    getItemImageUrl(itemName) {
        // 로컬 이미지 경로로 아이템 이름을 파일명으로 변환
        const nameToFileName = {
            // Weapon Items
            'Basic Magazine': 'basic_magazine',
            'High-Velocity Mag': 'high_velocity_mag', 
            'Headshot Booster': 'headshot_booster',
            'Close Quarters': 'close_quarters',
            'Berserker': 'berserker',
            'Sharpshooter': 'sharpshooter',
            'Burst Fire': 'burst_fire',
            'Titanic Magazine': 'titanic_magazine',
            'Glass Cannon': 'glass_cannon',
            
            // Vitality Items
            'Extra Health': 'extra_health',
            'Extra Regen': 'extra_regen',
            'Sprint Boots': 'sprint_boots',
            'Healing Rite': 'healing_rite',
            'Bullet Armor': 'bullet_armor',
            'Spirit Armor': 'spirit_armor',
            'Enduring Speed': 'enduring_speed',
            'Fortitude': 'fortitude',
            'Colossus': 'colossus',
            'Metal Skin': 'colossus', // 임시로 colossus 이미지 사용
            
            // Spirit Items
            'Extra Spirit': 'extra_charge', // Extra Charge와 동일한 이미지
            'Mystic Burst': 'mystic_burst',
            'Infuser': 'infuser',
            'Spirit Strike': 'spirit_strike',
            'Quicksilver Reload': 'quicksilver_reload',
            'Improved Cooldown': 'improved_cooldown',
            'Improved Reach': 'improved_reach',
            'Superior Cooldown': 'superior_cooldown',
            'Refresher': 'refresher'
        };
        
        // 파일명이 매핑되어 있는 경우 로컬 이미지 경로 반환
        const fileName = nameToFileName[itemName];
        if (fileName) {
            // 아이템 타입 결정 (기본값은 weapon)
            let category = 'weapon';
            if (this.fallbackItems.vitality[itemName]) {
                category = 'vitality';
            } else if (this.fallbackItems.spirit[itemName]) {
                category = 'spirit';
            }
            return `/images/items/${category}/${fileName}.svg`;
        }
        
        // 매핑되지 않은 아이템은 기본 이미지 반환
            'Superior Stamina': 'https://cdn.deadlock.coach/vpk/panorama/images/items/vitality/superior_stamina.webp',
            'Veil Walker': 'https://cdn.deadlock.coach/vpk/panorama/images/items/vitality/veil_walker.webp',
            'Fortitude': 'https://cdn.deadlock.coach/vpk/panorama/images/items/vitality/fortitude.webp',
            'Lifestrike': 'https://cdn.deadlock.coach/vpk/panorama/images/items/vitality/lifestrike.webp',
            'Phantom Strike': 'https://cdn.deadlock.coach/vpk/panorama/images/items/vitality/phantom_strike.webp',
            'Restorative Locket': 'https://cdn.deadlock.coach/vpk/panorama/images/items/vitality/restorative_locket.webp',
            'Superior Duration': 'https://cdn.deadlock.coach/vpk/panorama/images/items/vitality/superior_duration.webp',
            'Unstoppable': 'https://cdn.deadlock.coach/vpk/panorama/images/items/vitality/unstoppable.webp',
            'Leviathan': 'https://cdn.deadlock.coach/vpk/panorama/images/items/vitality/leviathan.webp',
            'Majestic Leap': 'https://cdn.deadlock.coach/vpk/panorama/images/items/vitality/majestic_leap.webp',
            'Soul Rebirth': 'https://cdn.deadlock.coach/vpk/panorama/images/items/vitality/soul_rebirth.webp',
            
            // Spirit 아이템들
            'Spirit Strike': 'https://cdn.deadlock.coach/vpk/panorama/images/items/spirit/spirit_strike.webp',
            'Ammo Scavenger': 'https://cdn.deadlock.coach/vpk/panorama/images/items/spirit/ammo_scavenger.webp',
            'Infuser': 'https://cdn.deadlock.coach/vpk/panorama/images/items/spirit/infuser.webp',
            'Decay': 'https://cdn.deadlock.coach/vpk/panorama/images/items/spirit/decay.webp',
            'Slowing Hex': 'https://cdn.deadlock.coach/vpk/panorama/images/items/spirit/slowing_hex.webp',
            'Superior Cooldown': 'https://cdn.deadlock.coach/vpk/panorama/images/items/spirit/superior_cooldown.webp',
            'Improved Burst': 'https://cdn.deadlock.coach/vpk/panorama/images/items/spirit/improved_burst.webp',
            'Improved Reach': 'https://cdn.deadlock.coach/vpk/panorama/images/items/spirit/improved_reach.webp',
            'Improved Spirit': 'https://cdn.deadlock.coach/vpk/panorama/images/items/spirit/improved_spirit.webp',
            'Mystic Vulnerability': 'https://cdn.deadlock.coach/vpk/panorama/images/items/spirit/mystic_vulnerability.webp',
            'Quicksilver Reload': 'https://cdn.deadlock.coach/vpk/panorama/images/items/spirit/quicksilver_reload.webp',
            'Withering Whip': 'https://cdn.deadlock.coach/vpk/panorama/images/items/spirit/withering_whip.webp',
            'Escalating Exposure': 'https://cdn.deadlock.coach/vpk/panorama/images/items/spirit/escalating_exposure.webp',
            'Knockdown': 'https://cdn.deadlock.coach/vpk/panorama/images/items/spirit/knockdown.webp',
            'Magic Carpet': 'https://cdn.deadlock.coach/vpk/panorama/images/items/spirit/magic_carpet.webp',
            'Rapid Recharge': 'https://cdn.deadlock.coach/vpk/panorama/images/items/spirit/rapid_recharge.webp',
            'Silence Glyph': 'https://cdn.deadlock.coach/vpk/panorama/images/items/spirit/silence_glyph.webp',
            'Diviner\'s Kevlar': 'https://cdn.deadlock.coach/vpk/panorama/images/items/spirit/diviners_kevlar.webp',
            'Mystic Reverb': 'https://cdn.deadlock.coach/vpk/panorama/images/items/spirit/mystic_reverb.webp'
        };
        
        return '/images/items/weapon/basic_magazine.svg';
    }

    getItemNameById(itemId) {
        const itemMap = {
            // Weapon Items (무기) - Tier 1
            715762406: 'Basic Magazine',
            1342610602: 'Close Quarters',
            1437614329: 'Headshot Booster',
            4072270083: 'High-Velocity Mag',
            2220233739: 'Hollow Point Ward',
            1009965641: 'Monster Rounds',
            4147641675: 'Rapid Rounds',
            499683006: 'Restorative Shot',

            // Weapon Items (무기) - Tier 2
            1842576017: 'Active Reload',
            393974127: 'Berserker',
            2981692841: 'Escalating Resilience',
            4139877411: 'Fleetfoot',
            1414319208: "Hunter's Aura",
            509856396: 'Kinetic Dash',
            3633614685: 'Long Range',
            2824119765: 'Melee Charge',
            3731635960: 'Mystic Shot',
            1254091416: 'Point Blank',
            2481177645: 'Pristine Emblem',
            223594321: 'Sharpshooter',
            3713423303: 'Soul Shredder Bullets',
            3140772621: 'Surge of Power',
            2163598980: 'Tesla Bullets',
            865846625: 'Titanic Magazine',
            395944548: 'Toxic Bullets',
            2356412290: 'Vampiric Burst',
            1925087134: 'Warp Stone',

            // Weapon Items (무기) - Tier 3
            2617435668: 'Alchemical Fire',
            1102081447: 'Burst Fire',
            2037039379: 'Crippling Headshot',
            677738769: 'Frenzy',
            3215534794: 'Glass Cannon',
            2876734447: 'Inhibitor',
            2746434652: 'Leech',
            3878070816: 'Lucky Shot',
            2469449027: 'Richochet',
            1829830659: 'Spiritual Overflow',
            3916766904: 'Torment Pulse',
            2876421943: 'Wrecker',

            // Vitality Items (생명력) - Tier 1
            968099481: 'Extra Health',
            2678489038: 'Extra Regen',
            558396679: 'Extra Stamina',
            395867183: 'Melee Lifesteal',
            1548066885: 'Sprint Boots',
            1797283378: 'Healing Rite',
            1710079648: 'Bullet Armor',
            2059712766: 'Spirit Armor',

            // Vitality Items (생명력) - Tier 2
            3147316197: 'Enduring Speed',
            857669956: 'Reactive Barrier',
            1813726886: 'Debuff Remover',
            3361075077: 'Divine Barrier',
            2603935618: "Enchanter's Barrier",
            7409189: 'Healing Booster',
            2081037738: 'Return Fire',
            3261353684: 'Rescue Beam',
            3287678549: 'Combat Barrier',
            2147483647: 'Improved Bullet Armor',
            2147483648: 'Improved Spirit Armor',
            1067869798: 'Superior Stamina',
            2948329856: 'Veil Walker',

            // Vitality Items (생명력) - Tier 3
            3428915467: 'Fortitude',
            1289536726: 'Lifestrike',
            2108901849: 'Metal Skin',
            2743563891: 'Phantom Strike',
            3745693205: 'Restorative Locket',
            4293016574: 'Superior Duration',
            2364891047: 'Unstoppable',
            1547821036: 'Colossus',
            3982475103: 'Leviathan',
            2849173567: 'Majestic Leap',
            1203847295: 'Soul Rebirth',

            // Spirit Items (정신력) - Tier 1
            380806748: 'Extra Spirit',
            811521119: 'Spirit Strike',
            1292979587: 'Mystic Burst',
            3403085434: 'Ammo Scavenger',
            1144549437: 'Infuser',
            2951612397: 'Spirit Lifesteal',
            84321454: 'Cold Front',
            381961617: 'Decay',
            2533252781: 'Slowing Hex',
            3919289022: 'Superior Cooldown',

            // Spirit Items (정신력) - Tier 2
            2820116164: 'Improved Burst',
            3005970438: 'Improved Reach',
            3357231760: 'Improved Spirit',
            3612042342: 'Mystic Vulnerability',
            3270001687: 'Quicksilver Reload',
            2800629741: 'Withering Whip',
            600033864: 'Escalating Exposure',
            1378931225: 'Ethereal Shift',
            2147483649: 'Knockdown',
            2147483650: 'Magic Carpet',
            2147483651: 'Rapid Recharge',
            2147483652: 'Silence Glyph',

            // Spirit Items (정신력) - Tier 3
            1829830660: 'Boundless Spirit',
            3916766905: "Diviner's Kevlar",
            2469449028: 'Echo Shard',
            3878070817: 'Mystic Reverb',
            2746434653: 'Refresher',

            // 추가된 아이템 ID들 (server.js와 동기화)
            715762406: 'Basic Magazine',
            1342610602: 'Close Quarters',
            1437614329: 'Headshot Booster',
            4072270083: 'High-Velocity Mag',
            2220233739: 'Hollow Point Ward',
            1009965641: 'Monster Rounds',
            4147641675: 'Rapid Rounds',
            499683006: 'Restorative Shot',
            1842576017: 'Active Reload',
            393974127: 'Berserker',
            2981692841: 'Escalating Resilience',
            4139877411: 'Fleetfoot',
            1414319208: "Hunter's Aura",
            509856396: 'Kinetic Dash',
            3633614685: 'Long Range',
            2824119765: 'Melee Charge',
            3731635960: 'Mystic Shot',
            1254091416: 'Point Blank',
            2481177645: 'Pristine Emblem',
            223594321: 'Sharpshooter',
            3713423303: 'Soul Shredder Bullets',
            3140772621: 'Surge of Power',
            2163598980: 'Tesla Bullets',
            865846625: 'Titanic Magazine',
            395944548: 'Toxic Bullets',
            2356412290: 'Vampiric Burst',
            1925087134: 'Warp Stone',
            2617435668: 'Alchemical Fire',
            1102081447: 'Burst Fire',
            2037039379: 'Crippling Headshot',
            677738769: 'Frenzy',
            3215534794: 'Glass Cannon',
            2876734447: 'Inhibitor',
            2746434652: 'Leech',
            3878070816: 'Lucky Shot',
            2469449027: 'Richochet',
            1829830659: 'Spiritual Overflow',
            3916766904: 'Torment Pulse',
            2876421943: 'Wrecker',
            968099481: 'Extra Health',
            2678489038: 'Extra Regen',
            558396679: 'Extra Stamina',
            395867183: 'Melee Lifesteal',
            1548066885: 'Sprint Boots',
            1797283378: 'Healing Rite',
            1710079648: 'Bullet Armor',
            2059712766: 'Spirit Armor',
            3147316197: 'Enduring Speed',
            857669956: 'Reactive Barrier',
            1813726886: 'Debuff Remover',
            3361075077: 'Divine Barrier',
            2603935618: "Enchanter's Barrier",
            7409189: 'Healing Booster',
            2081037738: 'Return Fire',
            3261353684: 'Rescue Beam',
            3287678549: 'Combat Barrier',
            2147483647: 'Improved Bullet Armor',
            2147483648: 'Improved Spirit Armor',
            1067869798: 'Superior Stamina',
            2948329856: 'Veil Walker',
            3428915467: 'Fortitude',
            1289536726: 'Lifestrike',
            2108901849: 'Metal Skin',
            2743563891: 'Phantom Strike',
            3745693205: 'Restorative Locket',
            4293016574: 'Superior Duration',
            2364891047: 'Unstoppable',
            1547821036: 'Colossus',
            3982475103: 'Leviathan',
            2849173567: 'Majestic Leap',
            1203847295: 'Soul Rebirth',
            380806748: 'Extra Spirit',
            811521119: 'Spirit Strike',
            1292979587: 'Mystic Burst',
            3403085434: 'Ammo Scavenger',
            1144549437: 'Infuser',
            2951612397: 'Spirit Lifesteal',
            84321454: 'Cold Front',
            381961617: 'Decay',
            2533252781: 'Slowing Hex',
            3919289022: 'Superior Cooldown',
            2820116164: 'Improved Burst',
            3005970438: 'Improved Reach',
            3357231760: 'Improved Spirit',
            3612042342: 'Mystic Vulnerability',
            3270001687: 'Quicksilver Reload',
            2800629741: 'Withering Whip',
            600033864: 'Escalating Exposure',
            1378931225: 'Ethereal Shift',
            2147483649: 'Knockdown',
            2147483650: 'Magic Carpet',
            2147483651: 'Rapid Recharge',
            2147483652: 'Silence Glyph',
            1829830660: 'Boundless Spirit',
            3916766905: "Diviner's Kevlar",
            2469449028: 'Echo Shard',
            3878070817: 'Mystic Reverb',
            2746434653: 'Refresher',
            
            // 매칭된 실제 ID들 (이전 분석에서 발견)
            2460791803: 'Berserker',
            1458044103: 'Basic Magazine', 
            1537272748: 'Extra Health',
            1835738020: 'Monster Rounds',
            3977876567: 'Tesla Bullets',
            3970837787: 'Spirit Armor',
            3791587546: 'Bullet Armor',
            2095565695: 'Extra Spirit',
            1282141666: 'Mystic Burst',
            1955841979: 'Metal Skin',
            339443430: 'Colossus',
            673001892: 'Ethereal Shift',
            3812615317: 'Echo Shard',
            
            // 새로 발견된 ID (1656913918 포함) - 추정 매핑
            1656913918: 'Superior Cooldown',
            1055679805: 'Spirit Strike',
            1080948381: 'Ammo Scavenger',
            112198670: 'Healing Rite',
            1128670012: 'Infuser',
            1142270357: 'Decay',
            1150006784: 'Slowing Hex',
            1193964439: 'Cold Front',
            1252627263: 'Improved Burst',
            1307289689: 'Improved Reach',
            1366719170: 'Quicksilver Reload',
            1396247347: 'Withering Whip',
            1414025773: 'Escalating Exposure',
            1454278799: 'Knockdown',
            1593133799: 'Rapid Recharge',
            1914797280: 'Silence Glyph',
            1917840730: 'Enduring Speed',
            1928108461: 'Reactive Barrier',
            1976391348: 'Debuff Remover',
            1998374645: 'Combat Barrier',
            1999680326: 'Rescue Beam'
        };
        return itemMap[itemId] || `Unknown Item (${itemId})`;
    }
}

// 글로벌 아이템 매니저 인스턴스
const itemManager = new DeadlockItemManager();

// 매치 처리 클래스
class DeadlockMatchProcessor {
    constructor(itemManager) {
        this.itemManager = itemManager;
    }

    async processMatchData(matchData) {
        try {
            console.log('🎮 매치 데이터 처리 시작:', matchData.matchId);
            
            // 아이템 데이터 처리
            if (matchData.items && Array.isArray(matchData.items)) {
                matchData.processedItems = matchData.items.slice(0, 12).map(item => {
                    const itemData = this.itemManager.getItemData(item.name);
                    return {
                        ...item,
                        ...itemData,
                        isUnknown: itemData.type === 'unknown'
                    };
                });
                
                console.log(`✅ ${matchData.processedItems.length}개 아이템 처리 완료`);
            } else {
                // 아이템 데이터가 없으면 기본 아이템 생성
                matchData.processedItems = this.generateFallbackItems(matchData.hero);
                console.log('⚠️ 아이템 데이터 없음, 기본 아이템 생성');
            }
            
            return matchData;
        } catch (error) {
            console.error('❌ 매치 데이터 처리 실패:', error);
            matchData.processedItems = this.generateFallbackItems();
            return matchData;
        }
    }

    generateFallbackItems(heroName = 'Default') {
        // 영웅별 아이템 빌드 예시
        const heroBuildMap = {
            'Abrams': ['Basic Magazine', 'Extra Health', 'Berserker', 'Bullet Armor', 'Extra Spirit', 'Fortitude'],
            'Bebop': ['High-Velocity Mag', 'Sprint Boots', 'Sharpshooter', 'Spirit Armor', 'Mystic Burst', 'Superior Cooldown'],
            'Dynamo': ['Extra Spirit', 'Extra Health', 'Infuser', 'Healing Rite', 'Improved Cooldown', 'Refresher'],
            'Grey Talon': ['Headshot Booster', 'Extra Health', 'Sharpshooter', 'Bullet Armor', 'Burst Fire', 'Glass Cannon'],
            'Haze': ['Close Quarters', 'Sprint Boots', 'Berserker', 'Enduring Speed', 'Burst Fire', 'Glass Cannon'],
            'Infernus': ['Basic Magazine', 'Extra Spirit', 'Spirit Strike', 'Spirit Armor', 'Improved Cooldown', 'Superior Cooldown'],
            'Ivy': ['Extra Spirit', 'Healing Rite', 'Infuser', 'Spirit Armor', 'Improved Reach', 'Refresher'],
            'Kelvin': ['Extra Health', 'Extra Spirit', 'Healing Rite', 'Bullet Armor', 'Spirit Strike', 'Colossus'],
            'Lady Geist': ['Extra Spirit', 'Sprint Boots', 'Mystic Burst', 'Spirit Armor', 'Improved Cooldown', 'Superior Cooldown'],
            'Lash': ['Extra Health', 'Extra Spirit', 'Spirit Strike', 'Enduring Speed', 'Improved Reach', 'Colossus'],
            'McGinnis': ['Basic Magazine', 'Extra Health', 'Healing Rite', 'Bullet Armor', 'Spirit Armor', 'Fortitude'],
            'Mo & Krill': ['Extra Health', 'Sprint Boots', 'Healing Rite', 'Bullet Armor', 'Enduring Speed', 'Colossus'],
            'Paradox': ['Extra Spirit', 'Extra Health', 'Mystic Burst', 'Spirit Armor', 'Improved Cooldown', 'Refresher'],
            'Pocket': ['Basic Magazine', 'Extra Spirit', 'Infuser', 'Bullet Armor', 'Quicksilver Reload', 'Superior Cooldown'],
            'Seven': ['Extra Spirit', 'Extra Health', 'Mystic Burst', 'Spirit Armor', 'Improved Cooldown', 'Superior Cooldown'],
            'Shiv': ['Basic Magazine', 'Sprint Boots', 'Close Quarters', 'Enduring Speed', 'Berserker', 'Glass Cannon'],
            'Vindicta': ['Headshot Booster', 'Extra Health', 'Sharpshooter', 'Bullet Armor', 'Burst Fire', 'Titanic Magazine'],
            'Viscous': ['Extra Health', 'Extra Spirit', 'Healing Rite', 'Spirit Armor', 'Spirit Strike', 'Colossus'],
            'Warden': ['Basic Magazine', 'Extra Health', 'Healing Rite', 'Bullet Armor', 'Extra Spirit', 'Fortitude'],
            'Wraith': ['Basic Magazine', 'Extra Spirit', 'Infuser', 'Spirit Armor', 'Quicksilver Reload', 'Superior Cooldown'],
            'Yamato': ['Close Quarters', 'Sprint Boots', 'Spirit Strike', 'Enduring Speed', 'Improved Reach', 'Colossus']
        };
        
        // 영웅별 아이템이 있으면 사용, 없으면 기본 아이템
        const fallbackItems = heroBuildMap[heroName] || [
            'Basic Magazine', 'Extra Health', 'Extra Spirit',
            'Bullet Armor', 'Mystic Burst', 'Metal Skin'
        ];
        
        return fallbackItems.map(itemName => {
            const itemData = this.itemManager.getItemData(itemName);
            return {
                name: itemName,
                ...itemData,
                isFallback: true
            };
        });
    }
}

// 글로벌 매치 프로세서 인스턴스
const matchProcessor = new DeadlockMatchProcessor(itemManager);

// 기존 함수를 새 시스템으로 대체
function getItemImage(itemName) {
    const itemData = itemManager.getItemData(itemName);
    return itemData.image;
}

function updateHeroesGrid(heroes) {
    const grid = document.getElementById('heroes-grid');
    
    const getHeroImage = (heroName) => {
        const heroImageMap = {
            'Abrams': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/bull_card.webp',
            'Bebop': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/bebop_card.webp',
            'Dynamo': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/dynamo_card.webp',
            'Grey Talon': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/archer_card.webp',
            'Haze': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/haze_card.webp',
            'Infernus': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/inferno_card.webp',
            'Ivy': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/ivy_card.webp',
            'Kelvin': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/kelvin_card.webp',
            'Lady Geist': 'https://assets-bucket.deadlock-api.com/assets-api-res/images/heroes/spectre_mm.webp',
            'Lash': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/lash_card.webp',
            'McGinnis': 'https://assets-bucket.deadlock-api.com/assets-api-res/images/heroes/engineer_mm.webp',
            'Mo & Krill': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/digger_card.webp',
            'Paradox': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/chrono_card.webp',
            'Pocket': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/synth_card.webp',
            'Seven': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/gigawatt_card.webp',
            'Shiv': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/shiv_card.webp',
            'Vindicta': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/hornet_card.webp',
            'Viper': 'https://assets-bucket.deadlock-api.com/assets-api-res/images/heroes/kali_mm.webp',
            'Viscous': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/viscous_card.webp',
            'Warden': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/warden_card.webp',
            'Holliday': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/astro_card.webp',
            'Mirage': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/mirage_card.webp',
            'Wraith': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/wraith_card.webp',
            'Yamato': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/yamato_card.webp'
        };
        return heroImageMap[heroName] || 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/bull_card.webp';
    };
    
    grid.innerHTML = heroes.map(hero => `
        <div class="hero-card">
            <img src="${getHeroImage(hero.name)}" alt="${hero.name}" class="hero-card-image">
            <div class="hero-card-info">
                <h3>${hero.name}</h3>
                <div class="hero-card-stats">
                    <div class="hero-stat-line">${hero.matches}게임 · ${hero.winRate}% 승률</div>
                    <div class="hero-kda-line">KDA: ${hero.kda || '0.0'}</div>
                </div>
            </div>
        </div>
    `).join('');
}

function updateMatchesList(matches) {
    const list = document.getElementById('matches-list');
    
    console.log('🎮 Updating matches list:', matches?.length, 'matches');
    if (matches && matches.length > 0) {
        matches.forEach((match, index) => {
            console.log(`📋 Match ${index + 1}:`, {
                hero: match.hero,
                result: match.result,
                itemCount: match.items?.length || 0,
                items: match.items?.map(item => item.name) || []
            });
        });
    }
    
    const getHeroImage = (heroName) => {
        const heroImageMap = {
            'Abrams': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/bull_card.webp',
            'Bebop': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/bebop_card.webp',
            'Dynamo': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/dynamo_card.webp',
            'Grey Talon': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/archer_card.webp',
            'Haze': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/haze_card.webp',
            'Infernus': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/inferno_card.webp',
            'Ivy': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/ivy_card.webp',
            'Kelvin': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/kelvin_card.webp',
            'Lady Geist': 'https://assets-bucket.deadlock-api.com/assets-api-res/images/heroes/spectre_mm.webp',
            'Lash': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/lash_card.webp',
            'McGinnis': 'https://assets-bucket.deadlock-api.com/assets-api-res/images/heroes/engineer_mm.webp',
            'Mo & Krill': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/digger_card.webp',
            'Paradox': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/chrono_card.webp',
            'Pocket': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/synth_card.webp',
            'Seven': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/gigawatt_card.webp',
            'Shiv': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/shiv_card.webp',
            'Vindicta': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/hornet_card.webp',
            'Viper': 'https://assets-bucket.deadlock-api.com/assets-api-res/images/heroes/kali_mm.webp',
            'Viscous': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/viscous_card.webp',
            'Warden': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/warden_card.webp',
            'Holliday': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/astro_card.webp',
            'Mirage': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/mirage_card.webp',
            'Wraith': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/wraith_card.webp',
            'Yamato': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/yamato_card.webp'
        };
        return heroImageMap[heroName] || 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/bull_card.webp';
    };
    
    list.innerHTML = matches.map(match => `
        <div class="match-card ${match.result === '승리' ? 'win' : 'loss'}">
            <div class="match-hero">
                <img src="${getHeroImage(match.hero)}" alt="${match.hero}" class="match-hero-image">
                <span class="match-result ${match.result === '승리' ? 'win' : 'loss'}">${match.result}</span>
            </div>
            
            <div class="match-kda">
                ${match.kills}/${match.deaths}/${match.assists}
            </div>
            
            <div class="match-stats">
                <span>${(match.damage / 1000).toFixed(1)}k 데미지</span>
                <span>${(match.healing / 1000).toFixed(1)}k 힐링</span>
                <span>${match.denies} 디나이</span>
                <span>${match.soulsPerMin}/분 소울</span>
                <span>${match.duration}분</span>
                <span>팀 순위 ${match.teamRank}</span>
            </div>
            
            <div class="match-items">
                <div class="items-label">최종 아이템</div>
                <div class="items-grid" id="match-items-${match.matchId}">
                    <!-- 아이템은 JavaScript로 동적 생성 -->
                </div>
            </div>
        </div>
    `).join('');
    
    // 각 매치의 아이템을 새로운 시스템으로 처리
    matches.forEach(async (match, index) => {
        try {
            // 매치 데이터를 새로운 시스템으로 처리
            const processedMatch = await matchProcessor.processMatchData(match);
            const itemsContainer = document.getElementById(`match-items-${match.matchId}`);
            
            if (itemsContainer && processedMatch.processedItems) {
                console.log(`🎯 매치 ${match.matchId} 아이템 렌더링:`, processedMatch.processedItems.length, '개');
                
                itemsContainer.innerHTML = processedMatch.processedItems.map(item => {
                    // 아이템 타입별 테두리 색상
                    const borderColor = item.isUnknown ? '#ff6b6b' : 
                                       item.isFallback ? '#ffd93d' : 
                                       item.color || '#66c2a5';
                    
                    // 아이템 티어별 배경 투명도
                    const opacity = item.isUnknown ? '0.5' : 
                                   item.isFallback ? '0.7' : '1.0';
                    
                    return `<div class="item-wrapper" style="position: relative; display: inline-block;">
                                <img src="${item.image}" 
                                     alt="${item.name}" 
                                     class="item-image ${item.type || 'unknown'}-item" 
                                     title="${item.name}${item.isUnknown ? ' (Unknown)' : ''}${item.isFallback ? ' (예시)' : ''}"
                                     style="border: 2px solid ${borderColor}; opacity: ${opacity};"
                                     onload="console.log('✅ 아이템 로드 성공:', '${item.name}')"
                                     onerror="console.error('❌ 아이템 로드 실패:', '${item.name}'); this.src='/images/items/weapon/basic_magazine.svg';">
                                ${item.isUnknown ? '<div class="unknown-badge">?</div>' : ''}
                            </div>`;
                }).join('');
            } else if (itemsContainer) {
                // 완전히 실패한 경우 기본 아이템 표시
                console.log('⚠️ 매치', match.matchId, '처리 실패, 기본 아이템 표시');
                const fallbackItems = matchProcessor.generateFallbackItems(match.hero);
                
                itemsContainer.innerHTML = fallbackItems.map(item => {
                    return `<div class="item-wrapper">
                                <img src="${item.image}" 
                                     alt="${item.name}" 
                                     class="item-image fallback-item" 
                                     title="${item.name} (기본)"
                                     style="border: 2px solid #ffd93d; opacity: 0.6;">
                            </div>`;
                }).join('');
            }
        } catch (error) {
            console.error(`❌ 매치 ${match.matchId} 아이템 처리 실패:`, error);
        }
    });
}

async function loadPartyMembers() {
    try {
        console.log('🔍 파티 멤버 로딩 시작...');
        const response = await fetch(`/api/v1/players/<%= accountId %>/party-stats`);
        const partyMembers = await response.json();
        
        console.log('📡 파티 멤버 API 응답:', {
            status: response.status,
            ok: response.ok,
            dataType: typeof partyMembers,
            isArray: Array.isArray(partyMembers),
            length: partyMembers?.length,
            data: partyMembers
        });
        
        if (response.ok && Array.isArray(partyMembers)) {
            // 각 멤버의 랭크 데이터 확인
            partyMembers.forEach((member, index) => {
                console.log(`👥 파티 멤버 ${index + 1}: ${member.name}`, {
                    accountId: member.accountId,
                    rank: member.rank,
                    hasRank: !!member.rank,
                    medal: member.rank?.medal,
                    subrank: member.rank?.subrank
                });
            });
            
            updatePartyMembersList(partyMembers);
        } else {
            console.error('Failed to load party members:', partyMembers);
            document.getElementById('party-members-list').innerHTML = '<p style="text-align: center; color: #999;">파티 멤버를 불러올 수 없습니다.</p>';
        }
    } catch (error) {
        console.error('Party members loading error:', error);
        document.getElementById('party-members-list').innerHTML = '<p style="text-align: center; color: #999;">파티 멤버를 불러올 수 없습니다.</p>';
    }
}

function updatePartyMembersList(partyMembers) {
    const list = document.getElementById('party-members-list');
    
    if (!partyMembers || partyMembers.length === 0) {
        list.innerHTML = '<p style="text-align: center; color: #999;">함께 플레이한 팀원이 없습니다.</p>';
        return;
    }
    
    // 메달 이미지 매핑 함수 - 리더보드와 동일한 매핑
    const getMedalImage = (medal, subrank) => {
        const medalRankMap = {
            'eternus': 11,
            'phantom': 10,
            'oracle': 9,
            'ritualist': 8,
            'alchemist': 7,
            'arcanist': 6,
            'initiate': 5
        };
        
        const rankNumber = medalRankMap[medal?.toLowerCase()] || 5;
        const subrankFormatted = subrank || 1;
        
        const imageUrl = `https://cdn.deadlock.coach/vpk/panorama/images/ranked/badges/rank${rankNumber}/badge_sm_subrank${subrankFormatted}.webp`;
        console.log(`🏆 파티 멤버 랭크 이미지 생성: ${medal} ${subrank} → ${imageUrl}`);
        
        return imageUrl;
    };
    
    // 파티 멤버용 한글 메달명 변환 함수
    const getKoreanMedal = (englishMedal) => {
        const medalTranslation = {
            'Eternus': '이터누스',
            'Phantom': '팬텀',
            'Oracle': '오라클',
            'Ritualist': '리츄얼리스트',
            'Alchemist': '알케미스트',
            'Arcanist': '아케니스트',
            'Initiate': '탐험가'
        };
        return medalTranslation[englishMedal] || englishMedal;
    };
    
    const getHeroImage = (heroName) => {
        const heroImageMap = {
            'Abrams': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/bull_card.webp',
            'Bebop': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/bebop_card.webp',
            'Dynamo': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/dynamo_card.webp',
            'Grey Talon': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/archer_card.webp',
            'Haze': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/haze_card.webp',
            'Infernus': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/inferno_card.webp',
            'Ivy': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/ivy_card.webp',
            'Kelvin': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/kelvin_card.webp',
            'Lady Geist': 'https://assets-bucket.deadlock-api.com/assets-api-res/images/heroes/spectre_mm.webp',
            'Lash': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/lash_card.webp',
            'McGinnis': 'https://assets-bucket.deadlock-api.com/assets-api-res/images/heroes/engineer_mm.webp',
            'Mo & Krill': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/digger_card.webp',
            'Paradox': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/chrono_card.webp',
            'Pocket': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/synth_card.webp',
            'Seven': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/gigawatt_card.webp',
            'Shiv': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/shiv_card.webp',
            'Vindicta': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/hornet_card.webp',
            'Viper': 'https://assets-bucket.deadlock-api.com/assets-api-res/images/heroes/kali_mm.webp',
            'Viscous': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/viscous_card.webp',
            'Warden': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/warden_card.webp',
            'Holliday': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/astro_card.webp',
            'Mirage': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/mirage_card.webp',
            'Wraith': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/wraith_card.webp',
            'Yamato': 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/yamato_card.webp'
        };
        return heroImageMap[heroName] || 'https://cdn.deadlock.coach/vpk/panorama/images/heroes/bull_card.webp';
    };

    list.innerHTML = partyMembers.map(member => {
        const accountId = member.accountId || member.memberId;
        
        // 랭크 데이터 안전성 확인 및 기본값 설정
        const rankData = member.rank || { medal: 'Initiate', subrank: 1 };
        const medal = rankData.medal || 'Initiate';
        const subrank = rankData.subrank || 1;
        
        console.log('🎮 파티 멤버 렌더링:', { 
            name: member.name, 
            accountId: accountId,
            originalRank: member.rank,
            processedRank: { medal, subrank }
        });
        
        return `
        <div class="party-member-card" onclick="viewPartyMemberProfile('${accountId}')" style="cursor: pointer;">
            <div class="party-member-info">
                <img src="${member.avatar}" alt="${member.name}" class="party-member-avatar" 
                     onerror="this.src='data:image/svg+xml;charset=utf-8,${encodeURIComponent('<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"50\" height=\"50\" viewBox=\"0 0 50 50\"><circle cx=\"25\" cy=\"25\" r=\"23\" fill=\"#666\" stroke=\"#fff\" stroke-width=\"2\"/><circle cx=\"25\" cy=\"18\" r=\"8\" fill=\"#fff\"/><path d=\"M8 40 Q25 32 42 40\" stroke=\"#fff\" stroke-width=\"4\" fill=\"none\"/></svg>')}'">
                <div class="party-member-details">
                    <h3>${member.name}</h3>
                    <div class="party-member-matches">${member.matches}경기 함께 플레이</div>
                    <div class="party-member-rank">
                        <img src="${getMedalImage(medal, subrank)}" 
                             alt="${getKoreanMedal(medal)}" class="rank-badge-small">
                        <span class="rank-text">${getKoreanMedal(medal)} ${subrank}</span>
                    </div>
                </div>
            </div>
            
            <div class="party-member-stats">
                <div class="party-stat-item">
                    <div class="label">승률</div>
                    <div class="value party-win-rate">${Math.round(member.winRate || 0)}%</div>
                </div>
                <div class="party-stat-item">
                    <div class="label">승</div>
                    <div class="value party-wins">${member.wins || 0}</div>
                </div>
                <div class="party-stat-item">
                    <div class="label">패</div>
                    <div class="value party-losses">${member.losses || 0}</div>
                </div>
                <div class="party-stat-item">
                    <div class="label">KDA</div>
                    <div class="value party-kda">${member.stats?.kda || '0.0'}</div>
                </div>
                <div class="party-stat-item">
                    <div class="label">평균 디나이</div>
                    <div class="value">${member.stats?.avgDenies || 0}</div>
                </div>
            </div>
            
            ${member.topHeroes && member.topHeroes.length > 0 ? `
                <div class="party-member-heroes">
                    <div class="heroes-label">주요 영웅</div>
                    <div class="heroes-list">
                        ${member.topHeroes.slice(0, 3).map(hero => `
                            <div class="hero-item">
                                <img src="${getHeroImage(hero.name)}" alt="${hero.name}" class="hero-mini-image">
                                <div class="hero-mini-stats">
                                    <div class="hero-name">${hero.name}</div>
                                    <div class="hero-winrate">${hero.winRate}% (${hero.matches}경기)</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : ''}
        </div>
    `;
    }).join('');
}

// 파티 멤버 프로필 보기
function viewPartyMemberProfile(accountId) {
    console.log('파티 멤버 프로필 클릭:', accountId);
    if (accountId && accountId !== 'undefined' && !accountId.startsWith('party_')) {
        console.log('프로필 페이지로 이동:', `/ko/players/${accountId}`);
        window.location.href = `/ko/players/${accountId}`;
    } else {
        console.log('유효하지 않은 계정 ID:', accountId);
        alert('이 플레이어의 프로필을 볼 수 없습니다. Account ID가 유효하지 않습니다.');
    }
}

// Load data when page loads
document.addEventListener('DOMContentLoaded', loadPlayerData);
</script>